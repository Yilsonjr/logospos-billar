<div class="container-fluid py-4 pb-5 mb-5">

  <!-- Header -->
  <div class="row justify-content-center mb-4">
    <div class="col-xl-10">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3 text-danger">
                <i class="fa-solid fa-store-slash fs-4"></i>
              </div>
              <div>
                <h4 class="fw-bold mb-0 text-dark">Cierre de Caja</h4>
                <small class="text-muted">Finaliza el turno y realiza el cuadre de efectivo</small>
              </div>
            </div>

            @if (cajaActual) {
            <div class="d-flex gap-4 d-none d-md-flex">
              <div class="text-end">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Cajero</small>
                <span class="fw-bold text-dark">{{ cajaActual.usuario_apertura }}</span>
              </div>
              <div class="text-end">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Inicio</small>
                <span class="fw-bold text-dark">{{ formatearHora(cajaActual.fecha_apertura) }}</span>
              </div>
              <div class="text-end">
                <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2">
                  <i class="fa-solid fa-circle me-1 small"></i>Turno Activo
                </span>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerta: No hay caja abierta -->
  @if (!cajaActual) {
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card border-danger shadow text-center p-5">
        <div class="mb-3">
          <i class="fa-solid fa-triangle-exclamation text-danger display-4"></i>
        </div>
        <h4 class="fw-bold text-danger">No hay caja abierta</h4>
        <p class="text-muted mb-4">Debes abrir un turno de caja antes de realizar el cierre.</p>
        <button class="btn btn-danger fw-bold shadow-sm" (click)="router.navigate(['/caja/apertura'])">
          <i class="fa-solid fa-key me-2"></i>Ir a Apertura de Caja
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Contenido Cierre -->
  @if (cajaActual) {
  <div class="row justify-content-center g-4">
    <!-- Columna Izquierda: Proceso de Cuadre -->
    <div class="col-xl-7 col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3">
          <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-calculator text-primary me-2"></i>Cuadre de Efectivo
          </h5>
        </div>

        <div class="card-body p-4">

          <!-- Paso 1: Info Sistema -->
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
              <div
                class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold me-2"
                style="width: 24px; height: 24px; font-size: 0.8rem;">1</div>
              <h6 class="fw-bold text-primary mb-0">INFORMACIÓN DEL SISTEMA</h6>
            </div>

            <div class="card bg-primary bg-opacity-10 border-0">
              <div class="card-body">
                <div class="row g-2 mb-3">
                  <div class="col-md-6">
                    <div class="bg-white p-2 rounded border d-flex justify-content-between">
                      <span class="text-muted small fw-bold">Inicial:</span>
                      <span class="fw-bold text-dark">{{ formatearMoneda(cajaActual.monto_inicial) }}</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="bg-white p-2 rounded border d-flex justify-content-between">
                      <span class="text-muted small fw-bold">Ventas Efec.:</span>
                      <span class="fw-bold text-dark">{{ formatearMoneda(ventasEfectivo) }}</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="bg-white p-2 rounded border d-flex justify-content-between">
                      <span class="text-muted small fw-bold">Entradas:</span>
                      <span class="fw-bold text-success">+{{ formatearMoneda(totalEntradas) }}</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="bg-white p-2 rounded border d-flex justify-content-between">
                      <span class="text-muted small fw-bold">Salidas:</span>
                      <span class="fw-bold text-danger">-{{ formatearMoneda(totalSalidas) }}</span>
                    </div>
                  </div>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center pt-2 border-top border-primary border-opacity-25">
                  <span class="fw-bold text-primary small text-uppercase">Efectivo Esperado</span>
                  <span class="h5 fw-bold text-primary mb-0">{{ formatearMoneda(montoEsperado) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 2: Conteo -->
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
              <div
                class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center fw-bold me-2"
                style="width: 24px; height: 24px; font-size: 0.8rem;">2</div>
              <h6 class="fw-bold text-success mb-0">CONTEO FÍSICO</h6>
            </div>

            <div class="card border-success border-2 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label fw-bold text-dark mb-0">¿Cuánto efectivo hay en caja?</label>
                  <button class="btn btn-sm btn-outline-primary fw-bold" (click)="verDetalleArqueo()">
                    <i class="fa-solid fa-coins me-2"></i>Contar Billetes
                  </button>
                </div>
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-light text-success fw-bold">RD$</span>
                  <input type="number" [(ngModel)]="totalContado" (input)="calcularDiferencia()"
                    class="form-control fw-bold text-success text-end fs-2" placeholder="0.00">
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 3: Resultado -->
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
              <div
                class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold me-2"
                style="width: 24px; height: 24px; font-size: 0.8rem;">3</div>
              <h6 class="fw-bold text-secondary mb-0">RESULTADO DEL CUADRE</h6>
            </div>

            <div class="card border-0"
              [ngClass]="diferencia === 0 ? 'bg-success-subtle' : (diferencia > 0 ? 'bg-warning-subtle' : 'bg-danger-subtle')">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-dark">Diferencia:</span>
                  <div class="text-end">
                    <h2 class="fw-bold mb-0"
                      [ngClass]="diferencia === 0 ? 'text-success' : (diferencia > 0 ? 'text-warning' : 'text-danger')">
                      {{ diferencia > 0 ? '+' : ''}}{{ formatearMoneda(diferencia) }}
                    </h2>
                    <small class="fw-bold"
                      [ngClass]="diferencia === 0 ? 'text-success' : (diferencia > 0 ? 'text-warning' : 'text-danger')">
                      <i class="fa-solid me-1"
                        [ngClass]="diferencia === 0 ? 'fa-check-circle' : 'fa-triangle-exclamation'"></i>
                      {{ diferencia === 0 ? 'Cuadrado Perfecto' : (diferencia > 0 ? 'Sobrante' : 'Faltante') }}
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <hr class="text-muted">

          <!-- Notas -->
          <div class="mb-3">
            <label class="form-label fw-bold text-muted small text-uppercase">
              <i class="fa-solid fa-note-sticky me-1"></i>Notas de Cierre
              @if (diferencia !== 0) { <span class="text-danger fw-bold ms-2">* OBLIGATORIO</span> }
            </label>
            <textarea [(ngModel)]="notasCierre" class="form-control" rows="3"
              [placeholder]="diferencia !== 0 ? 'Explica la diferencia encontrada...' : 'Observaciones opcionales...'"></textarea>
          </div>

        </div>
      </div>
    </div>

    <!-- Columna Derecha: Resumen -->
    <div class="col-xl-3 col-lg-4">
      <div class="card border-0 shadow-sm sticky-top" style="top: 2rem;">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="mb-0 fw-bold"><i class="fa-solid fa-chart-pie me-2"></i>Resumen del Turno</h6>
        </div>
        <div class="card-body p-4">
          <div class="d-flex justify-content-between mb-2 small">
            <span class="text-muted">Total Ventas:</span>
            <span class="fw-bold text-dark">{{ formatearMoneda(ventasEfectivo + ventasTarjeta) }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2 small">
            <span class="text-muted">Impuestos (18%):</span>
            <span class="fw-bold text-danger">-{{ formatearMoneda((ventasEfectivo + ventasTarjeta) * 0.18) }}</span>
          </div>
          <!-- Linea -->
          <div class="border-top my-3"></div>
          <div class="d-flex justify-content-between mb-3">
            <span class="fw-bold text-dark">Ventas Netas:</span>
            <span class="fw-bold text-dark">{{ formatearMoneda((ventasEfectivo + ventasTarjeta) * 0.82) }}</span>
          </div>

          <div class="bg-success text-white rounded p-3 text-center mb-4 shadow-sm">
            <div class="small opacity-75 text-uppercase fw-bold mb-1">Ganancia Estimada</div>
            <div class="h3 fw-bold mb-0">{{ formatearMoneda((ventasEfectivo + ventasTarjeta) * 0.82) }}</div>
          </div>

          <div class="alert alert-light border small text-muted">
            <div class="fw-bold mb-2 text-dark"><i class="fa-solid fa-list-check me-2"></i>Verificaciones</div>
            <div class="d-flex align-items-center mb-1">
              <i class="fa-solid fa-check text-success me-2"></i>Ventas registradas
            </div>
            @if (diferencia === 0) {
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-check text-success me-2"></i>Efectivo Cuadrado
            </div>
            } @else {
            <div class="d-flex align-items-center text-danger">
              <i class="fa-solid fa-xmark me-2"></i>Diferencia en Caja
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra Inferior Fija -->
  <div class="fixed-bottom bg-white border-top shadow-lg py-3">
    <div class="container-fluid">
      <div class="row justify-content-center align-items-center">
        <div class="col-xl-10 d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-4 d-none d-md-flex">
            <div>
              <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Esperado</small>
              <span class="fw-bold text-dark fs-5">{{ formatearMoneda(montoEsperado) }}</span>
            </div>
            <div>
              <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Contado</small>
              <span class="fw-bold text-dark fs-5">{{ formatearMoneda(totalContado) }}</span>
            </div>
            <div class="px-3 py-1 rounded"
              [ngClass]="diferencia === 0 ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'">
              <small class="d-block text-uppercase fw-bold" style="font-size: 0.65rem;">
                {{ diferencia === 0 ? 'Perfecto' : 'Diferencia' }}
              </small>
              <span class="fw-bold fs-5">{{ diferencia > 0 ? '+' : '' }}{{ formatearMoneda(diferencia) }}</span>
            </div>
          </div>

          <button class="btn btn-lg btn-danger shadow fw-bold px-5" (click)="confirmarCierre()"
            [disabled]="diferencia !== 0 && !notasCierre">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-lock me-3"></i>
              <div class="text-start lh-1">
                <div class="small opacity-75 fw-normal">Finalizar</div>
                <div>Cerrar Caja</div>
              </div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Espaciador Footer -->
  <div style="height: 100px;"></div>
  }

</div>

<!-- Modal Arqueo Detallado -->
@if (mostrarArqueo) {
<div class="modal-backdrop fade show"></div>
<div class="modal fade show d-block" tabindex="-1" style="display: block;">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold"><i class="fa-solid fa-coins me-2"></i>Arqueo de Efectivo</h5>
        <button type="button" class="btn-close btn-close-white" (click)="mostrarArqueo = false"></button>
      </div>

      <div class="modal-body bg-light">
        <div class="row g-4">
          <!-- Billetes -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-success text-white py-2">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-money-bill me-2"></i>Billetes</h6>
              </div>
              <div class="card-body p-3">
                @for (billete of denominaciones.billetes; track billete.valor) {
                <div class="d-flex align-items-center mb-2">
                  <div class="text-muted small fw-bold" style="width: 50px;">{{ billete.etiqueta }}</div>
                  <input type="number" class="form-control form-control-sm text-center fw-bold mx-2"
                    [(ngModel)]="arqueo['billetes_' + billete.valor]" (input)="calcularArqueo()" placeholder="0"
                    min="0">
                  <div class="text-end fw-bold text-dark" style="width: 80px;">
                    {{ formatearMoneda(arqueo['billetes_' + billete.valor] * billete.valor) }}
                  </div>
                </div>
                }
                <div class="border-top pt-2 mt-2 d-flex justify-content-between align-items-center">
                  <small class="text-muted fw-bold">TOTAL BILLETES</small>
                  <span class="fw-bold text-success">{{ formatearMoneda(totalBilletes) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Monedas -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-warning text-dark py-2">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-coins me-2"></i>Monedas</h6>
              </div>
              <div class="card-body p-3">
                @for (moneda of denominaciones.monedas; track moneda.valor) {
                <div class="d-flex align-items-center mb-2">
                  <div class="text-muted small fw-bold" style="width: 50px;">{{ moneda.etiqueta }}</div>
                  <input type="number" class="form-control form-control-sm text-center fw-bold mx-2"
                    [(ngModel)]="arqueo['monedas_' + moneda.valor]" (input)="calcularArqueo()" placeholder="0" min="0">
                  <div class="text-end fw-bold text-dark" style="width: 80px;">
                    {{ formatearMoneda(arqueo['monedas_' + moneda.valor] * moneda.valor) }}
                  </div>
                </div>
                }
                <div class="border-top pt-2 mt-2 d-flex justify-content-between align-items-center">
                  <small class="text-muted fw-bold">TOTAL MONEDAS</small>
                  <span class="fw-bold text-warning">{{ formatearMoneda(totalMonedas) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row justify-content-center mt-4">
          <div class="col-md-6 text-center">
            <div class="bg-dark text-white p-3 rounded shadow-sm">
              <small class="text-uppercase opacity-75 d-block">Total Arqueado</small>
              <h2 class="fw-bold mb-0 m-0">{{ formatearMoneda(totalContado) }}</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button class="btn btn-secondary" (click)="mostrarArqueo = false">Cancelar</button>
        <button class="btn btn-primary fw-bold px-4" (click)="aplicarArqueo()">Aplicar Conteo</button>
      </div>
    </div>
  </div>
</div>
}

<!-- Modal Confirmacion -->
@if (mostrarConfirmacion) {
<div class="modal-backdrop fade show"></div>
<div class="modal fade show d-block" tabindex="-1" style="display: block;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-danger border-top border-5">
      <div class="modal-body p-5 text-center">
        <div class="mb-4">
          <span class="fa-stack fa-3x text-danger">
            <i class="fa-solid fa-circle fa-stack-2x opacity-25"></i>
            <i class="fa-solid fa-lock fa-stack-1x"></i>
          </span>
        </div>
        <h3 class="fw-bold text-dark mb-2">¿Confirmar Cierre de Caja?</h3>
        <p class="text-muted mb-4">Esta acción finalizará el turno actual y registrará el cuadre. No podrás deshacer
          esta acción.</p>

        <div class="bg-light p-3 rounded mb-4 text-start">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Esperado:</span>
            <span class="fw-bold">{{ formatearMoneda(montoEsperado) }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Real:</span>
            <span class="fw-bold">{{ formatearMoneda(totalContado) }}</span>
          </div>
          <div class="border-top my-2"></div>
          <div class="d-flex justify-content-between">
            <span class="fw-bold text-dark">Diferencia:</span>
            <span class="fw-bold" [ngClass]="diferencia === 0 ? 'text-success' : 'text-danger'">
              {{ formatearMoneda(diferencia) }}
            </span>
          </div>
        </div>

        <div class="d-flex gap-3 justify-content-center">
          <button class="btn btn-light border px-4 fw-bold" (click)="mostrarConfirmacion = false">Cancelar</button>
          <button class="btn btn-danger px-4 fw-bold shadow-sm" (click)="cerrarCaja()">
            <i class="fa-solid fa-check me-2"></i>Sí, Cerrar Caja
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}