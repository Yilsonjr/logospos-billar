<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary">
        <i class="fa-solid fa-calculator fs-4"></i>
      </div>
      <div>
        <h4 class="fw-bold mb-0 text-dark">Arqueo de Caja</h4>
        <small class="text-muted">Verifica el efectivo en caja sin cerrar el turno</small>
      </div>
    </div>
  </div>

  <!-- Sin Caja Abierta -->
  @if (!cajaActual) {
  <div class="alert alert-warning d-flex align-items-center shadow-sm" role="alert">
    <i class="fa-solid fa-triangle-exclamation fs-4 me-3"></i>
    <div>
      <strong>No hay una caja abierta.</strong> Debes abrir un turno de caja primero.
    </div>
  </div>
  }

  <!-- Contenido -->
  @if (cajaActual) {
  <div class="row g-4">
    <!-- Columna Izquierda: Info y Resumen -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-4">

          <!-- Info Caja -->
          <div class="mb-4">
            <h6 class="fw-bold text-uppercase text-muted small mb-3">
              <i class="fa-solid fa-info-circle me-1"></i>Información de Caja
            </h6>
            <ul class="list-group list-group-flush small">
              <li class="list-group-item d-flex justify-content-between px-0">
                <span class="text-muted">Apertura</span>
                <span class="fw-bold text-dark">{{ formatearFecha(cajaActual.fecha_apertura) }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between px-0">
                <span class="text-muted">Usuario</span>
                <span class="fw-bold text-dark">{{ cajaActual.usuario_apertura }}</span>
              </li>
            </ul>
          </div>

          <!-- Resumen Financiero -->
          <div class="mb-4">
            <h6 class="fw-bold text-uppercase text-muted small mb-3">
              <i class="fa-solid fa-chart-pie me-1"></i>Resumen Financiero
            </h6>
            <div class="bg-light rounded p-3">
              <div class="d-flex justify-content-between mb-2 small">
                <span class="text-muted">Monto Inicial</span>
                <span class="fw-bold text-dark">{{ formatearMoneda(cajaActual.monto_inicial) }}</span>
              </div>
              <div class="d-flex justify-content-between mb-2 small">
                <span class="text-muted">Ventas Efectivo</span>
                <span class="fw-bold text-success">+{{ formatearMoneda(ventasEfectivo) }}</span>
              </div>
              <div class="d-flex justify-content-between mb-2 small">
                <span class="text-muted">Entradas</span>
                <span class="fw-bold text-success">+{{ formatearMoneda(totalEntradas) }}</span>
              </div>
              <div class="d-flex justify-content-between mb-3 small">
                <span class="text-muted">Salidas</span>
                <span class="fw-bold text-danger">-{{ formatearMoneda(totalSalidas) }}</span>
              </div>
              <div class="border-top pt-2 d-flex justify-content-between align-items-center">
                <span class="fw-bold text-primary small text-uppercase">Esperado en Caja</span>
                <span class="h5 fw-bold text-primary mb-0">{{ formatearMoneda(montoEsperado) }}</span>
              </div>
            </div>
          </div>

          <!-- Resultado -->
          <div>
            <h6 class="fw-bold text-uppercase text-muted small mb-3">
              <i class="fa-solid fa-balance-scale me-1"></i>Resultado Actual
            </h6>
            <div class="text-center p-3 rounded border"
              [ngClass]="diferencia === 0 ? 'bg-success-subtle border-success' : (diferencia > 0 ? 'bg-warning-subtle border-warning' : 'bg-danger-subtle border-danger')">
              <small class="d-block text-muted text-uppercase fw-bold mb-1">Diferencia</small>
              <h3 class="fw-bold mb-1"
                [ngClass]="diferencia === 0 ? 'text-success' : (diferencia > 0 ? 'text-warning' : 'text-danger')">
                {{ diferencia > 0 ? '+' : '' }}{{ formatearMoneda(diferencia) }}
              </h3>
              <small class="fw-bold"
                [ngClass]="diferencia === 0 ? 'text-success' : (diferencia > 0 ? 'text-warning' : 'text-danger')">
                {{ diferencia === 0 ? 'Cuadrado' : (diferencia > 0 ? 'Sobrante' : 'Faltante') }}
              </small>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Columna Derecha: Conteo -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-bold text-dark"><i class="fa-solid fa-money-bills me-2 text-success"></i>Conteo de Efectivo
          </h6>
          <button class="btn btn-sm btn-light border text-muted" (click)="limpiarArqueo()">
            <i class="fa-solid fa-eraser me-2"></i>Limpiar
          </button>
        </div>
        <div class="card-body p-4">

          <!-- Billetes -->
          <div class="mb-4">
            <h6 class="fw-bold text-success mb-3 small text-uppercase">Billetes</h6>
            <div class="row g-2">
              @for (billete of denominaciones.billetes; track billete.valor) {
              <div class="col-6 col-md-4">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-light text-success fw-bold" style="width: 80px;">{{ billete.etiqueta
                    }}</span>
                  <input type="number" [(ngModel)]="arqueo['billetes_' + billete.valor]" (input)="calcularArqueo()"
                    class="form-control text-center fw-bold" placeholder="0" min="0">
                </div>
                <div class="text-end text-muted small mt-1 fw-bold" style="font-size: 0.75rem;">
                  = {{ formatearMoneda(arqueo['billetes_' + billete.valor] * billete.valor) }}
                </div>
              </div>
              }
            </div>
            <div class="text-end mt-2 pt-2 border-top">
              <small class="text-muted me-2">Subtotal Billetes:</small>
              <span class="fw-bold text-success">{{ formatearMoneda(totalBilletes) }}</span>
            </div>
          </div>

          <!-- Monedas -->
          <div class="mb-4">
            <h6 class="fw-bold text-warning mb-3 small text-uppercase">Monedas</h6>
            <div class="row g-2">
              @for (moneda of denominaciones.monedas; track moneda.valor) {
              <div class="col-6 col-md-4">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-light text-warning fw-bold" style="width: 80px;">{{ moneda.etiqueta
                    }}</span>
                  <input type="number" [(ngModel)]="arqueo['monedas_' + moneda.valor]" (input)="calcularArqueo()"
                    class="form-control text-center fw-bold" placeholder="0" min="0">
                </div>
                <div class="text-end text-muted small mt-1 fw-bold" style="font-size: 0.75rem;">
                  = {{ formatearMoneda(arqueo['monedas_' + moneda.valor] * moneda.valor) }}
                </div>
              </div>
              }
            </div>
            <div class="text-end mt-2 pt-2 border-top">
              <small class="text-muted me-2">Subtotal Monedas:</small>
              <span class="fw-bold text-warning">{{ formatearMoneda(totalMonedas) }}</span>
            </div>
          </div>

          <div class="bg-light rounded p-3 border text-center">
            <small class="text-uppercase text-muted fw-bold d-block mb-1">Total Contado</small>
            <h2 class="fw-bold text-primary mb-0">{{ formatearMoneda(totalContado) }}</h2>
          </div>

        </div>
      </div>

      <div class="alert alert-info d-flex align-items-center small" role="alert">
        <i class="fa-solid fa-circle-info me-3 fs-5"></i>
        <div>
          <strong>Nota:</strong> Este arqueo es solo informativo para verificar el efectivo en cualquier momento. Para
          cerrar el turno, utiliza la opción "Cierre de Caja".
        </div>
      </div>
    </div>
  </div>
  }
</div>