<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-dark mb-1">
        <i class="fa-solid fa-cash-register me-2 text-primary"></i>Historial de Cajas
      </h2>
      <p class="text-muted mb-0">Consulta y audita los turnos de caja realizados</p>
    </div>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small fw-bold text-muted">Estado</label>
          <select [(ngModel)]="filtroEstado" (change)="aplicarFiltros()" class="form-select form-select-sm">
            <option value="todos">Todos</option>
            <option value="abierta">Abierta</option>
            <option value="cerrada">Cerrada</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold text-muted">Fecha Inicio</label>
          <input type="date" [(ngModel)]="fechaInicio" (change)="aplicarFiltros()" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold text-muted">Fecha Fin</label>
          <input type="date" [(ngModel)]="fechaFin" (change)="aplicarFiltros()" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <button class="btn btn-light border w-100 text-secondary" (click)="limpiarFiltros()">
            <i class="fa-solid fa-xmark me-2"></i>Limpiar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla Cajas -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 py-3 text-uppercase small fw-bold text-muted">Fecha</th>
              <th class="py-3 text-uppercase small fw-bold text-muted">Usuario</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-end">Inicial</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-end">Final</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-end">Diferencia</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-center">Duraci√≥n</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-center">Estado</th>
              <th class="pe-4 py-3 text-uppercase small fw-bold text-muted text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (caja of cajasFiltradas; track caja.id) {
            <tr>
              <td class="ps-4 py-3">
                <div class="fw-medium text-dark">{{ formatearFechaCorta(caja.fecha_apertura) }}</div>
                <small class="text-muted">{{ formatearFecha(caja.fecha_apertura).split(',')[1] }}</small>
              </td>
              <td class="py-3 text-muted">
                <div class="d-flex align-items-center">
                  <div
                    class="rounded-circle bg-light text-secondary d-flex justify-content-center align-items-center me-2"
                    style="width: 24px; height: 24px;">
                    <i class="fa-solid fa-user small"></i>
                  </div>
                  {{ caja.usuario_apertura }}
                </div>
              </td>
              <td class="py-3 text-end font-monospace text-secondary">
                {{ formatearMoneda(caja.monto_inicial) }}
              </td>
              <td class="py-3 text-end font-monospace fw-bold text-dark">
                {{ caja.monto_final ? formatearMoneda(caja.monto_final) : '-' }}
              </td>
              <td class="py-3 text-end font-monospace fw-bold">
                @if (caja.diferencia !== undefined && caja.diferencia !== null) {
                <span [class.text-success]="caja.diferencia >= 0" [class.text-danger]="caja.diferencia < 0">
                  {{ caja.diferencia > 0 ? '+' : ''}}{{ formatearMoneda(caja.diferencia) }}
                </span>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="py-3 text-center text-muted small">
                <i class="fa-regular fa-clock me-1"></i>{{ calcularDuracion(caja.fecha_apertura, caja.fecha_cierre) }}
              </td>
              <td class="py-3 text-center">
                @if (caja.estado === 'abierta') {
                <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">
                  <i class="fa-solid fa-door-open me-1"></i>Abierta
                </span>
                } @else {
                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill">
                  <i class="fa-solid fa-lock me-1"></i>Cerrada
                </span>
                }
              </td>
              <td class="pe-4 py-3 text-end">
                <button class="btn btn-sm btn-light text-primary border shadow-sm" (click)="verDetalles(caja)"
                  title="Ver Detalles">
                  <i class="fa-solid fa-eye me-1"></i>Detalles
                </button>
              </td>
            </tr>
            }
            @if (cajasFiltradas.length === 0) {
            <tr>
              <td colspan="8" class="py-5 text-center text-muted">
                <div class="d-flex flex-column align-items-center opacity-50">
                  <i class="fa-solid fa-cash-register fa-3x mb-3"></i>
                  <p class="mb-0 fw-medium">No se encontraron registros de caja</p>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal Detalles Premium -->
@if (mostrarDetalles) {
<div class="custom-overlay" (click)="cerrarDetalles()">
  <div class="custom-modal-content" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="modal-header-custom">
      <h5 class="mb-0 fw-bold d-flex align-items-center">
        <div class="bg-white bg-opacity-20 p-2 rounded-lg me-3 d-flex align-items-center">
          <i class="fa-solid fa-file-invoice-dollar fs-5"></i>
        </div>
        @if (cajaSeleccionada) {
        Detalle de Caja #{{ cajaSeleccionada.caja.id }}
        } @else {
        Cargando Detalles...
        }
      </h5>
      <button type="button" class="btn-close btn-close-white opacity-75" (click)="cerrarDetalles()"></button>
    </div>

    <!-- Scrollable Body -->
    <div class="modal-body-custom">

      @if (!cajaSeleccionada) {
      <div class="py-5 text-center">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p class="text-slate-500 fw-bold">Cargando detalles de caja...</p>
      </div>
      } @else {

      <!-- Info Turno Grid -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="bg-white p-3 rounded-2xl border-start border-4 border-success shadow-sm">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-success bg-opacity-10 p-2 rounded-lg text-success me-3">
                <i class="fa-solid fa-door-open"></i>
              </div>
              <h6 class="fw-800 text-slate-800 mb-0">Apertura</h6>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-slate-400 small fw-600">Fecha y Hora</span>
              <span class="text-slate-700 small fw-800">{{ formatearFecha(cajaSeleccionada.caja.fecha_apertura)
                }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-slate-400 small fw-600">Usuario</span>
              <span class="text-slate-700 small fw-800">{{ cajaSeleccionada.caja.usuario_apertura }}</span>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="bg-white p-3 rounded-2xl border-start border-4 shadow-sm"
            [ngClass]="cajaSeleccionada.caja.fecha_cierre ? 'border-indigo-500' : 'border-amber-500'">
            <div class="d-flex align-items-center mb-3">
              <div class="p-2 rounded-lg me-3"
                [ngClass]="cajaSeleccionada.caja.fecha_cierre ? 'bg-indigo-50 text-indigo-500' : 'bg-amber-50 text-amber-500'">
                <i class="fa-solid" [class.fa-lock]="cajaSeleccionada.caja.fecha_cierre"
                  [class.fa-clock]="!cajaSeleccionada.caja.fecha_cierre"></i>
              </div>
              <h6 class="fw-800 text-slate-800 mb-0">Estado del Turno</h6>
            </div>
            @if (cajaSeleccionada.caja.fecha_cierre) {
            <div class="d-flex justify-content-between mb-2">
              <span class="text-slate-400 small fw-600">Cierre</span>
              <span class="text-slate-700 small fw-800">{{ formatearFecha(cajaSeleccionada.caja.fecha_cierre) }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-slate-400 small fw-600">Cajero</span>
              <span class="text-slate-700 small fw-800">{{ cajaSeleccionada.caja.usuario_cierre }}</span>
            </div>
            } @else {
            <div class="py-2 text-center">
              <span class="badge bg-amber-100 text-amber-700 px-3 py-2 rounded-pill fw-bold">
                <i class="fa-solid fa-spinner fa-spin-pulse me-2"></i>Turno en Curso
              </span>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Resumen de Totales -->
      <h6 class="text-slate-500 fw-800 x-small text-uppercase ls-wider mb-3">Resumen Financiero</h6>
      <div class="row g-2 mb-4">
        <div class="col-6 col-md-3">
          <div class="bg-white p-3 rounded-xl border text-center shadow-xs">
            <span class="d-block text-slate-400 fw-700 x-small text-uppercase mb-1">Inicial</span>
            <span class="d-block fw-900 text-slate-700">{{ formatearMoneda(cajaSeleccionada.caja.monto_inicial)
              }}</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="bg-white p-3 rounded-xl border-bottom border-success border-4 text-center shadow-xs">
            <span class="d-block text-success fw-700 x-small text-uppercase mb-1">Ventas (+)</span>
            <span class="d-block fw-900 text-slate-700">{{ formatearMoneda(cajaSeleccionada.total_ventas) }}</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="bg-white p-3 rounded-xl border-bottom border-cyan-500 border-4 text-center shadow-xs">
            <span class="d-block text-cyan-600 fw-700 x-small text-uppercase mb-1">Entradas (+)</span>
            <span class="d-block fw-900 text-slate-700">{{ formatearMoneda(cajaSeleccionada.total_entradas) }}</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="bg-white p-3 rounded-xl border-bottom border-rose-500 border-4 text-center shadow-xs">
            <span class="d-block text-rose-600 fw-700 x-small text-uppercase mb-1">Salidas (-)</span>
            <span class="d-block fw-900 text-slate-700">{{ formatearMoneda(cajaSeleccionada.total_salidas) }}</span>
          </div>
        </div>
      </div>

      <!-- Wallet Alert -->
      <div
        class="bg-indigo-600 p-3 rounded-2xl d-flex justify-content-between align-items-center shadow-lg mb-4 text-white">
        <div class="d-flex align-items-center">
          <div class="bg-white bg-opacity-20 p-2 rounded-lg me-3">
            <i class="fa-solid fa-wallet"></i>
          </div>
          <span class="fw-800">Efectivo Calculado en Caja:</span>
        </div>
        <span class="h3 fw-900 mb-0">{{ formatearMoneda(cajaSeleccionada.efectivo_disponible) }}</span>
      </div>

      <!-- Tabla de Movimientos Compacta -->
      <div class="d-flex justify-content-between align-items-end mb-3">
        <h6 class="text-slate-500 fw-800 x-small text-uppercase ls-wider mb-0">Movimientos Recientes</h6>
        <span class="badge bg-slate-100 text-slate-600 rounded-pill px-3">{{ cajaSeleccionada.movimientos.length }}
          registros</span>
      </div>

      <div class="card border-0 shadow-sm overflow-hidden mb-4">
        <div class="table-responsive" style="max-height: 250px;">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-slate-50 sticky-top">
              <tr>
                <th class="ps-4 py-3 x-small fw-800 text-slate-400 text-uppercase">Hora</th>
                <th class="py-3 x-small fw-800 text-slate-400 text-uppercase text-center">Tipo</th>
                <th class="py-3 x-small fw-800 text-slate-400 text-uppercase">Concepto</th>
                <th class="pe-4 py-3 x-small fw-800 text-slate-400 text-uppercase text-end">Monto</th>
              </tr>
            </thead>
            <tbody class="border-top-0">
              @for (mov of cajaSeleccionada.movimientos; track mov.id) {
              <tr class="border-bottom border-slate-50">
                <td class="ps-4 py-3 small fw-600 text-slate-500">{{ formatearFecha(mov.created_at || '').split(',')[1]
                  }}</td>
                <td class="text-center">
                  @if (mov.tipo === 'entrada') { <span
                    class="badge bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-1">Entrada</span> }
                  @else if (mov.tipo === 'salida') { <span
                    class="badge bg-rose-50 text-rose-600 border border-rose-100 px-2 py-1">Salida</span> }
                  @else { <span class="badge bg-blue-50 text-blue-600 border border-blue-100 px-2 py-1">Venta</span> }
                </td>
                <td class="small fw-700 text-slate-700">{{ mov.concepto }}</td>
                <td class="pe-4 py-3 text-end fw-900" [class.text-rose-600]="mov.tipo === 'salida'"
                  [class.text-emerald-600]="mov.tipo !== 'salida'">
                  {{ mov.tipo === 'salida' ? '-' : '+' }}{{ formatearMoneda(mov.monto) }}
                </td>
              </tr>
              }
              @if (cajaSeleccionada.movimientos.length === 0) {
              <tr>
                <td colspan="4" class="text-center text-slate-400 py-5">
                  <i class="fa-solid fa-folder-open d-block fs-2 mb-2 opacity-25"></i>
                  No hay movimientos registrados
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Panel de Arqueo -->
      @if (cajaSeleccionada.arqueo) {
      <div class="bg-slate-900 p-4 rounded-3xl text-white shadow-xl">
        <div class="d-flex align-items-center mb-4">
          <div class="bg-white bg-opacity-10 p-2 rounded-lg me-3 text-emerald-400">
            <i class="fa-solid fa-clipboard-check fs-5"></i>
          </div>
          <h6 class="fw-800 mb-0">Arqueo Final Auditado</h6>
        </div>
        <div class="row g-3">
          <div class="col-4 text-center border-end border-white border-opacity-10">
            <span class="d-block text-white text-opacity-50 x-small fw-700 text-uppercase mb-1">Contado</span>
            <span class="h5 fw-900 mb-0">{{ formatearMoneda(cajaSeleccionada.arqueo.total_contado) }}</span>
          </div>
          <div class="col-4 text-center border-end border-white border-opacity-10">
            <span class="d-block text-white text-opacity-50 x-small fw-700 text-uppercase mb-1">Esperado</span>
            <span class="h5 fw-900 mb-0">{{ formatearMoneda(cajaSeleccionada.arqueo.total_esperado) }}</span>
          </div>
          <div class="col-4 text-center">
            <span class="d-block text-white text-opacity-50 x-small fw-700 text-uppercase mb-1">Diferencia</span>
            <span class="h5 fw-900 mb-0"
              [ngClass]="cajaSeleccionada.arqueo.diferencia >= 0 ? 'text-emerald-400' : 'text-rose-400'">
              {{ cajaSeleccionada.arqueo.diferencia > 0 ? '+' : '' }}{{
              formatearMoneda(cajaSeleccionada.arqueo.diferencia) }}
            </span>
          </div>
        </div>
      </div>
      }
      }
    </div> <!-- .modal-body-custom -->

    <!-- Footer Actions -->
    <div class="modal-footer-custom">
      <button type="button" class="btn btn-light px-5 py-2 fw-800 text-slate-500 border rounded-xl"
        (click)="cerrarDetalles()">
        Cerrar Detalle
      </button>
    </div>

  </div>
</div>
}