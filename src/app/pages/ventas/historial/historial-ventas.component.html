<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-dark mb-1">
        <i class="fa-solid fa-clock-rotate-left me-2 text-primary"></i>Historial de Ventas
      </h2>
      <p class="text-muted mb-0">Consulta y gestiona todas las transacciones realizadas</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="exportarCSV()">
        <i class="fa-solid fa-file-csv me-2"></i>Exportar
      </button>
    </div>
  </div>

  <!-- KPI Stats -->
  <div class="row g-3 mb-4">
    <!-- Total Ventas -->
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary">
            <i class="fa-solid fa-chart-line fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted text-uppercase small fw-bold mb-1">Total Ventas</h6>
            <h4 class="fw-bold text-dark mb-0">{{ formatearMoneda(totalVentas) }}</h4>
            <small class="text-muted">{{ ventasFiltradas.length }} transacciones</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Efectivo -->
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3 text-success">
            <i class="fa-solid fa-money-bill-wave fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted text-uppercase small fw-bold mb-1">Efectivo</h6>
            <h4 class="fw-bold text-dark mb-0">{{ formatearMoneda(totalEfectivo) }}</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta -->
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3 text-info">
            <i class="fa-solid fa-credit-card fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted text-uppercase small fw-bold mb-1">Tarjeta</h6>
            <h4 class="fw-bold text-dark mb-0">{{ formatearMoneda(totalTarjeta) }}</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- Crédito / ITBIS (condicional) -->
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          @if (modoFiscalActivo) {
          <!-- Modo fiscal: muestra ITBIS recaudado -->
          <div class="rounded-circle p-3 me-3" style="background:#fef3c7; color:#d97706;">
            <i class="fa-solid fa-file-invoice-dollar fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted text-uppercase small fw-bold mb-1">ITBIS Recaudado</h6>
            <h4 class="fw-bold text-dark mb-0">{{ formatearMoneda(totalITBIS) }}</h4>
            <small class="text-muted">18% incluido</small>
          </div>
          } @else {
          <!-- Sin modo fiscal: muestra crédito -->
          <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3 text-warning">
            <i class="fa-solid fa-hand-holding-dollar fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted text-uppercase small fw-bold mb-1">Crédito</h6>
            <h4 class="fw-bold text-dark mb-0">{{ formatearMoneda(totalCredito) }}</h4>
          </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Filters & Actions -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
      <div class="row g-3 align-items-center">
        <!-- Búsqueda -->
        <div class="col-lg-4 col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0 text-muted">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
            <input type="text" [(ngModel)]="busqueda" (input)="aplicarFiltros()"
              class="form-control border-start-0 ps-0 shadow-none"
              [placeholder]="modoFiscalActivo ? 'Buscar por factura, NCF, RNC...' : 'Buscar por número de factura...'">
          </div>
        </div>

        <!-- Botones Filtros -->
        <div class="col-lg-8 col-md-6 d-flex justify-content-md-end gap-2">
          <button class="btn btn-light border text-secondary" (click)="toggleFiltros()" [class.active]="mostrarFiltros">
            <i class="fa-solid fa-filter me-2"></i>Filtros
          </button>
          <button class="btn btn-light border text-secondary" (click)="cargarVentas()" title="Actualizar">
            <i class="fa-solid fa-rotate"></i>
          </button>
        </div>
      </div>

      <!-- Panel Expandible Filtros -->
      @if (mostrarFiltros) {
      <div class="mt-3 pt-3 border-top animate-fade-in">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">Método Pago</label>
            <select [(ngModel)]="filtroMetodoPago" (change)="aplicarFiltros()" class="form-select form-select-sm">
              <option value="todos">Todos</option>
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="credito">Crédito</option>
              <option value="mixto">Mixto</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">Estado</label>
            <select [(ngModel)]="filtroEstado" (change)="aplicarFiltros()" class="form-select form-select-sm">
              <option value="todos">Todos</option>
              <option value="completada">Completada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <!-- Filtro NCF (solo en modo fiscal) -->
          @if (modoFiscalActivo) {
          <div class="col-md-3">
            <label class="form-label small fw-bold mb-1" style="color:#92400e;">
              <i class="fa-solid fa-file-invoice-dollar me-1"></i>Tipo NCF
            </label>
            <select [(ngModel)]="filtroTipoNCF" (change)="aplicarFiltros()" class="form-select form-select-sm">
              <option value="todos">Todos los tipos</option>
              @for (tipo of tiposNcf; track tipo.codigo) {
              <option [value]="tipo.codigo">{{ tipo.codigo }} — {{ tipo.descripcion }}</option>
              }
            </select>
          </div>
          }
          <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">Fecha Inicio</label>
            <input type="date" [(ngModel)]="fechaInicio" (change)="aplicarFiltros()"
              class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">Fecha Fin</label>
            <input type="date" [(ngModel)]="fechaFin" (change)="aplicarFiltros()" class="form-control form-control-sm">
          </div>
        </div>
        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-link btn-sm text-decoration-none text-muted" (click)="limpiarFiltros()">
            <i class="fa-solid fa-xmark me-1"></i>Limpiar filtros
          </button>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Tabla Ventas -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 py-3 text-uppercase small fw-bold text-muted">Fecha</th>
              <th class="py-3 text-uppercase small fw-bold text-muted">Factura</th>
              @if (modoFiscalActivo) {
              <th class="py-3 text-uppercase small fw-bold" style="color:#92400e;">NCF</th>
              }
              <th class="py-3 text-uppercase small fw-bold text-muted">Cliente</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-center">Método</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-end">Total</th>
              <th class="py-3 text-uppercase small fw-bold text-muted text-center">Estado</th>
              <th class="pe-4 py-3 text-uppercase small fw-bold text-muted text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @if (isLoading && ventasFiltradas.length === 0) {
            <tr>
              <td [attr.colspan]="modoFiscalActivo ? 8 : 7" class="py-5 text-center">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="text-muted small">Cargando transacciones...</p>
              </td>
            </tr>
            } @else {
            @for (venta of ventasFiltradas; track venta.id) {
            <tr>
              <td class="ps-4 py-3">
                <div class="fw-medium text-dark">{{ formatearFecha(venta.created_at || '') }}</div>
              </td>
              <td class="py-3">
                <span class="badge bg-light text-primary border border-primary-subtle fw-bold">
                  {{ venta.numero_venta }}
                </span>
              </td>
              <!-- Columna NCF: solo en modo fiscal -->
              @if (modoFiscalActivo) {
              <td class="py-3">
                @if (venta.ncf) {
                <div class="d-flex flex-column lh-1">
                  <span class="badge fw-bold font-monospace"
                    style="background:#fef3c7; color:#92400e; border:1px solid #fcd34d; font-size:0.7rem;">
                    {{ venta.ncf }}
                  </span>
                  @if (venta.tipo_ncf) {
                  <small class="text-muted mt-1" style="font-size:0.65rem;">{{ venta.tipo_ncf }}</small>
                  }
                </div>
                } @else {
                <span class="text-muted" style="font-size:0.75rem;">—</span>
                }
              </td>
              }
              <td class="py-3 text-muted">
                {{ venta.cliente_id || 'Cliente General' }}
              </td>
              <td class="py-3 text-center">
                @switch (venta.metodo_pago) {
                @case ('efectivo') { <span
                  class="badge bg-success-subtle text-success border border-success-subtle">Efectivo</span> }
                @case ('tarjeta') { <span
                  class="badge bg-info-subtle text-info border border-info-subtle">Tarjeta</span> }
                @case ('credito') { <span
                  class="badge bg-warning-subtle text-warning border border-warning-subtle">Crédito</span> }
                @case ('mixto') { <span class="badge border"
                  style="background-color:#ede9fe; color:#6d28d9; border-color:#c4b5fd;">Mixto</span> }
                @default { <span class="badge bg-secondary-subtle text-secondary">{{ venta.metodo_pago }}</span> }
                }
              </td>
              <td class="py-3 text-end fw-bold text-dark font-monospace">
                {{ formatearMoneda(venta.total) }}
              </td>
              <td class="py-3 text-center">
                @if (venta.estado === 'completada') {
                <span class="badge rounded-pill bg-success"><i class="fa-solid fa-check me-1"></i>Completada</span>
                } @else {
                <span class="badge rounded-pill bg-danger"><i class="fa-solid fa-ban me-1"></i>Cancelada</span>
                }
              </td>
              <td class="pe-4 py-3 text-end">
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-sm btn-icon btn-light text-primary" (click)="verDetalles(venta)"
                    title="Ver Detalles">
                    <i class="fa-solid fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-icon btn-light text-secondary" (click)="imprimirFactura(venta)"
                    title="Imprimir">
                    <i class="fa-solid fa-print"></i>
                  </button>
                  @if (venta.estado === 'completada') {
                  <button class="btn btn-sm btn-icon btn-light text-danger" (click)="cancelarVenta(venta)"
                    title="Cancelar Venta">
                    <i class="fa-solid fa-ban"></i>
                  </button>
                  }
                </div>
              </td>
            </tr>
            }
            @if (ventasFiltradas.length === 0) {
            <tr>
              <td [attr.colspan]="modoFiscalActivo ? 8 : 7" class="py-5 text-center text-muted">
                <div class="d-flex flex-column align-items-center">
                  <i class="fa-solid fa-inbox fa-3x mb-2 opacity-50"></i>
                  <p class="mb-0 fw-medium">No se encontraron ventas</p>
                </div>
              </td>
            </tr>
            }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal Detalles — overlay fijo z-index:10000, mismo patrón que modal.proveedores -->
@if (mostrarDetalles && ventaSeleccionada) {
<div class="modal-overlay" (click)="cerrarDetalles()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="modal-header-custom">
      <h5 class="fw-bold m-0">
        <i class="fa-solid fa-file-invoice me-2"></i>Detalles de Venta
      </h5>
      <button type="button" class="btn-close btn-close-white" (click)="cerrarDetalles()"></button>
    </div>

    <!-- Body -->
    <div class="modal-body-custom">

      <!-- Info General — 4 items en fila -->
      <div class="row g-3 mb-4">
        <!-- Factura -->
        <div class="col-sm-6 col-lg-3">
          <div class="p-3 rounded-3 border bg-light h-100">
            <small class="text-muted text-uppercase fw-bold d-block mb-1"
              style="font-size:.65rem; letter-spacing:.05em;">
              <i class="fa-solid fa-hashtag me-1"></i>Factura
            </small>
            <span class="fw-bold text-primary font-monospace" style="font-size:.9rem; word-break:break-all;">
              {{ ventaSeleccionada.numero_venta }}
            </span>
          </div>
        </div>
        <!-- Fecha -->
        <div class="col-sm-6 col-lg-3">
          <div class="p-3 rounded-3 border bg-light h-100">
            <small class="text-muted text-uppercase fw-bold d-block mb-1"
              style="font-size:.65rem; letter-spacing:.05em;">
              <i class="fa-solid fa-calendar me-1"></i>Fecha
            </small>
            <span class="fw-medium text-dark" style="font-size:.85rem;">
              {{ formatearFecha(ventaSeleccionada.created_at || '') }}
            </span>
          </div>
        </div>
        <!-- Cliente -->
        <div class="col-sm-6 col-lg-3">
          <div class="p-3 rounded-3 border bg-light h-100">
            <small class="text-muted text-uppercase fw-bold d-block mb-1"
              style="font-size:.65rem; letter-spacing:.05em;">
              <i class="fa-solid fa-user me-1"></i>Cliente
            </small>
            <span class="fw-medium text-dark" style="font-size:.9rem;">
              {{ ventaSeleccionada.cliente_nombre || 'Cliente General' }}
            </span>
          </div>
        </div>
        <!-- Método de pago -->
        <div class="col-sm-6 col-lg-3">
          <div class="p-3 rounded-3 border bg-light h-100">
            <small class="text-muted text-uppercase fw-bold d-block mb-2"
              style="font-size:.65rem; letter-spacing:.05em;">
              <i class="fa-solid fa-credit-card me-1"></i>Pago
            </small>
            @switch (ventaSeleccionada.metodo_pago) {
            @case ('efectivo') {
            <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1">
              <i class="fa-solid fa-money-bill-wave me-1"></i>Efectivo
            </span>
            }
            @case ('tarjeta') {
            <span class="badge bg-info-subtle text-info border border-info-subtle px-2 py-1">
              <i class="fa-solid fa-credit-card me-1"></i>Tarjeta
            </span>
            }
            @case ('credito') {
            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1">
              <i class="fa-solid fa-file-invoice-dollar me-1"></i>Crédito
            </span>
            }
            @case ('mixto') {
            <span class="badge border px-2 py-1" style="background-color:#ede9fe; color:#6d28d9; border-color:#c4b5fd;">
              <i class="fa-solid fa-wallet me-1"></i>Mixto
            </span>
            }
            @default {
            <span class="badge bg-secondary px-2 py-1">{{ ventaSeleccionada.metodo_pago }}</span>
            }
            }
          </div>
        </div>
      </div>

      <!-- Tabla Productos -->
      <h6 class="fw-bold text-dark mb-2">
        <i class="fa-solid fa-box-open me-2 text-primary"></i>Productos
      </h6>
      <div class="table-responsive mb-4 border rounded-3">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th class="text-center">Cant.</th>
              <th class="text-end">P. Unit.</th>
              <th class="text-end text-danger">Desc.</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            @for (detalle of ventaSeleccionada.detalles; track detalle.id) {
            <tr>
              <td class="fw-medium">{{ detalle.producto_nombre }}</td>
              <td class="text-center">
                <span class="badge bg-secondary-subtle text-secondary rounded-pill">{{ detalle.cantidad }}</span>
              </td>
              <td class="text-end text-muted">{{ formatearMoneda(detalle.precio_unitario) }}</td>
              <td class="text-end text-danger small">
                @if (detalle.descuento > 0) { -{{ formatearMoneda(detalle.descuento) }} } @else { — }
              </td>
              <td class="text-end fw-bold text-dark">{{ formatearMoneda(detalle.subtotal) }}</td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Totales -->
      <div class="row justify-content-end">
        <div class="col-sm-8 col-md-5">
          <div class="p-3 rounded-3 border bg-light">
            <div class="d-flex justify-content-between mb-2 small text-muted">
              <span>Subtotal:</span>
              <span class="fw-bold text-dark">{{ formatearMoneda(ventaSeleccionada.subtotal) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2 small text-muted">
              <span>Descuento:</span>
              <span class="fw-bold text-danger">-{{ formatearMoneda(ventaSeleccionada.descuento) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2 small text-muted">
              <span>Impuestos (ITBIS):</span>
              <span class="fw-bold text-dark">{{ formatearMoneda(ventaSeleccionada.impuestos) }}</span>
            </div>
            <div class="d-flex justify-content-between border-top pt-2 mt-1">
              <span class="h5 fw-bold text-dark mb-0">Total:</span>
              <span class="h5 fw-bold text-primary mb-0">{{ formatearMoneda(ventaSeleccionada.total) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- NCF si existe -->
      @if (ventaSeleccionada.ncf) {
      <div class="mt-3 p-2 rounded-2 border border-info-subtle bg-info-subtle">
        <small class="fw-bold text-info d-block">
          <i class="fa-solid fa-receipt me-1"></i>NCF: {{ ventaSeleccionada.ncf }}
          @if (ventaSeleccionada.tipo_ncf) { — {{ ventaSeleccionada.tipo_ncf }} }
        </small>
      </div>
      }

      <!-- Notas -->
      @if (ventaSeleccionada.notas) {
      <div class="mt-3 p-2 bg-light rounded-2 border">
        <small class="fw-bold text-muted d-block">
          <i class="fa-solid fa-note-sticky me-1"></i>Notas:
        </small>
        <span class="small font-monospace">{{ ventaSeleccionada.notas }}</span>
      </div>
      }

    </div><!-- /body -->

    <!-- Footer -->
    <div style="padding:.875rem 1.25rem; border-top:1px solid #e5e7eb; border-radius:0 0 12px 12px;
                display:flex; justify-content:flex-end; gap:.5rem; background:#f9fafb; flex-shrink:0;">
      <button class="btn btn-outline-secondary" (click)="imprimirFactura(ventaSeleccionada)">
        <i class="fa-solid fa-print me-2"></i>Imprimir
      </button>
      @if (ventaSeleccionada.estado === 'completada') {
      <button class="btn btn-outline-danger" (click)="cancelarVenta(ventaSeleccionada)">
        <i class="fa-solid fa-ban me-2"></i>Cancelar
      </button>
      }
      <button class="btn btn-dark" (click)="cerrarDetalles()">Cerrar</button>
    </div>

  </div><!-- /card -->
</div><!-- /overlay -->
}