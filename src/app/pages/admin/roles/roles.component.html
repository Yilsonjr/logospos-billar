<div class="container-fluid py-4 bg-light min-vh-100">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h2 class="fw-bold text-dark mb-0">Gestión de Roles</h2>
      <p class="text-muted small mb-0">Define los niveles de acceso y permisos del sistema</p>
    </div>
    <button (click)="abrirModalCrear()" class="btn btn-primary shadow-sm fw-bold">
      <i class="fa-solid fa-shield-halved me-2"></i> Nuevo Rol
    </button>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold small text-muted">Buscar</label>
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0"><i
                class="fa-solid fa-magnifying-glass text-muted"></i></span>
            <input type="text" [(ngModel)]="filtroTexto" (ngModelChange)="aplicarFiltros()"
              class="form-control border-start-0 bg-light" placeholder="Nombre o descripción del rol...">
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold small text-muted">Estado</label>
          <select [(ngModel)]="filtroEstado" (ngModelChange)="aplicarFiltros()" class="form-select bg-light">
            <option value="todos">Todos</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button (click)="filtroTexto = ''; filtroEstado = 'todos'; aplicarFiltros()"
            class="btn btn-light w-100 border text-muted">
            <i class="fa-solid fa-filter-circle-xmark me-2"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Roles Grid -->
  <div class="row g-4">
    <div *ngFor="let rol of rolesFiltrados" class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100 role-card">
        <div class="card-body p-4 d-flex flex-column">

          <!-- Card Header -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center gap-2">
              <div class="role-color-indicator rounded-circle shadow-sm" [style.background-color]="rol.color"></div>
              <h5 class="fw-bold text-dark mb-0">{{ rol.nombre }}</h5>
            </div>
            <span class="badge rounded-pill" [class.bg-success-subtle]="rol.activo" [class.text-success]="rol.activo"
              [class.bg-danger-subtle]="!rol.activo" [class.text-danger]="!rol.activo">
              {{ rol.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </div>

          <p class="text-muted small mb-4 flex-grow-1">{{ rol.descripcion }}</p>

          <!-- Stats -->
          <div class="row g-2 mb-4">
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center border border-light">
                <h4 class="fw-bold text-primary mb-0">{{ rol.permisos.length }}</h4>
                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Permisos</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center border border-light">
                <h4 class="fw-bold text-success mb-0">{{ contarUsuariosConRol(rol.id!) }}</h4>
                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Usuarios</small>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="d-flex justify-content-between align-items-center pt-3 border-top">
            <button (click)="verDetallesRol(rol)" class="btn btn-link text-decoration-none p-0 fw-bold small">
              Ver Detalles <i class="fa-solid fa-arrow-right ms-1"></i>
            </button>

            <div class="btn-group">
              <button (click)="abrirModalEditar(rol)" class="btn btn-sm btn-light text-primary border-0" title="Editar">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>
              <button (click)="cambiarEstadoRol(rol)" class="btn btn-sm btn-light border-0"
                [class.text-danger]="rol.activo" [class.text-success]="!rol.activo"
                [title]="rol.activo ? 'Desactivar' : 'Activar'">
                <i class="fa-solid" [class.fa-toggle-on]="rol.activo" [class.fa-toggle-off]="!rol.activo"></i>
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="rolesFiltrados.length === 0" class="text-center py-5">
    <div class="text-muted opacity-50 mb-3">
      <i class="fa-solid fa-user-shield display-4"></i>
    </div>
    <h5 class="text-dark fw-bold">No se encontraron roles</h5>
    <p class="text-muted small">Intenta ajustar los filtros de búsqueda</p>
  </div>

</div>


<!-- Modal Role (Bootstrap Style - Premium) -->
<div *ngIf="mostrarModal" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg overflow-hidden">

      <!-- Premium Header -->
      <div class="modal-header bg-gradient-roles text-white border-bottom-0 py-4 px-4">
        <div class="d-flex align-items-center gap-3">
          <div class="bg-white bg-opacity-25 rounded-circle p-3 d-flex align-items-center justify-content-center"
            style="width: 50px; height: 50px;">
            <i class="fa-solid fs-4" [class.fa-shield-halved]="modoModal === 'crear'"
              [class.fa-user-shield]="modoModal !== 'crear'"></i>
          </div>
          <div>
            <h5 class="modal-title fw-bold mb-0">
              {{ modoModal === 'crear' ? 'Nuevo Rol de Sistema' : 'Editar Rol' }}
            </h5>
            <p class="mb-0 small text-white-50">Define los niveles de acceso y permisos</p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <div class="modal-body p-0">
        <form (ngSubmit)="guardarRol()" #rolForm="ngForm" class="h-100">
          <div class="row g-0 h-100">

            <!-- Left Sidebar: Basic Config -->
            <div class="col-lg-4 bg-light p-4 border-end d-flex flex-column">
              <h6 class="fw-bold text-dark mb-4 ps-1 border-start border-4 border-primary ps-2">Configuración General
              </h6>

              <div class="form-floating mb-3">
                <input type="text" [(ngModel)]="formularioRol.nombre" name="nombre" required
                  class="form-control bg-white" id="floatRolName" placeholder="Nombre">
                <label for="floatRolName">Nombre del Rol *</label>
              </div>

              <div class="form-floating mb-4">
                <textarea [(ngModel)]="formularioRol.descripcion" name="descripcion" required
                  class="form-control bg-white" id="floatDesc" placeholder="Desc" style="height: 100px"></textarea>
                <label for="floatDesc">Descripción *</label>
              </div>

              <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                  <label class="form-label fw-bold small text-muted text-uppercase mb-2">Color de Identificación</label>
                  <div class="d-flex flex-wrap gap-2 mb-3">
                    <button *ngFor="let color of coloresPredefinidos" type="button"
                      (click)="formularioRol.color = color"
                      class="btn p-0 rounded-circle border-2 transition-transform hover-scale"
                      [style.background-color]="color" [class.border-dark]="formularioRol.color === color"
                      [class.border-white]="formularioRol.color !== color"
                      style="width: 28px; height: 28px; box-shadow: 0 0 0 1px #dee2e6;">
                    </button>
                  </div>
                  <input type="color" [(ngModel)]="formularioRol.color" name="color"
                    class="form-control form-control-color w-100 border-0 bg-light p-0"
                    title="Elige un color personalizado" style="height: 38px;">
                </div>
              </div>

              <div class="mt-auto">
                <div class="card bg-white border-0 shadow-sm">
                  <div class="card-body p-3 d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="fw-bold text-dark mb-0">Estado del Rol</h6>
                      <small class="text-muted">{{ formularioRol.activo ? 'Visible y asignable' : 'Oculto para nuevos
                        usuarios' }}</small>
                    </div>
                    <div class="form-check form-switch m-0">
                      <input class="form-check-input fs-5 ms-0" type="checkbox" role="switch" id="activoCheck"
                        [(ngModel)]="formularioRol.activo" name="activo">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Content: Permissions Matrix -->
            <div class="col-lg-8 p-4 bg-white">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-bold text-dark mb-0 ps-1 border-start border-4 border-success ps-2">
                  Permisos Asignados
                  <span class="badge bg-success rounded-pill ms-2">{{ formularioRol.permisos.length }}</span>
                </h6>
                <div class="text-end">
                  <small class="text-muted d-block">Selecciona los módulos a los que este rol tendrá acceso</small>
                </div>
              </div>

              <div class="permissions-container custom-scrollbar pe-2" style="max-height: 550px; overflow-y: auto;">
                <div *ngFor="let categoria of Object.keys(permisosAgrupados)" class="mb-4">
                  <div class="d-flex align-items-center p-2 rounded bg-light mb-2 border-start border-3"
                    [style.border-color]="categoriaEsCompleta(categoria) ? '#198754' : '#dee2e6'">
                    <div class="form-check mb-0">
                      <input class="form-check-input" type="checkbox" [checked]="categoriaEsCompleta(categoria)"
                        [indeterminate]="categoriaTienePermisos(categoria) && !categoriaEsCompleta(categoria)"
                        (change)="toggleCategoria(categoria)" [id]="'cat_' + categoria">
                      <label class="form-check-label fw-bold text-dark text-uppercase small ms-1"
                        [for]="'cat_' + categoria">
                        {{ obtenerNombreCategoria(categoria) }}
                      </label>
                    </div>
                    <span class="ms-auto badge bg-white text-dark border shadow-sm rounded-pill"
                      *ngIf="categoriaTienePermisos(categoria)">
                      {{ contarPermisosCategoria(categoria) }} seleccionados
                    </span>
                  </div>

                  <div class="row g-2 ps-3">
                    <div *ngFor="let permiso of Object.keys(permisosAgrupados[categoria])" class="col-md-6 col-xl-4">
                      <label class="permission-card card h-100 border hover-shadow cursor-pointer transition-all"
                        [class.border-primary]="tienePermiso(permiso)"
                        [class.bg-primary-subtle]="tienePermiso(permiso)">
                        <div class="card-body p-2 d-flex align-items-start gap-2">
                          <input class="form-check-input mt-1 flex-shrink-0" type="checkbox"
                            [checked]="tienePermiso(permiso)" (change)="togglePermiso(permiso)"
                            [id]="'perm_' + permiso">
                          <div class="small lh-sm" [class.fw-medium]="tienePermiso(permiso)"
                            [class.text-primary]="tienePermiso(permiso)" [class.text-muted]="!tienePermiso(permiso)">
                            {{ permisosAgrupados[categoria][permiso] }}
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                <button type="button" class="btn btn-light px-4 border" (click)="cerrarModal()">Cancelar</button>
                <button type="submit" [disabled]="isSaving || !rolForm.form.valid"
                  class="btn btn-primary px-4 fw-bold shadow-sm">
                  @if (isSaving) {
                  <span class="spinner-border spinner-border-sm me-2"></span> Guardando...
                  } @else {
                  <i class="fa-solid fa-floppy-disk me-2"></i> Guardar Configuración
                  }
                </button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<!-- =================== Modal Detalles del Rol =================== -->
<div *ngIf="mostrarDetalle && rolDetalle" class="modal d-block" tabindex="-1"
  style="background-color: rgba(0,0,0,0.55);" (click)="cerrarDetalle()">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" (click)="$event.stopPropagation()">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

      <!-- Header con color del rol -->
      <div class="modal-header text-white py-4 px-4 border-0"
        [style.background]="'linear-gradient(135deg, ' + rolDetalle.color + 'dd, ' + rolDetalle.color + '99)'">
        <div class="d-flex align-items-center gap-3 w-100">
          <div
            class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center shadow-sm flex-shrink-0"
            style="width: 52px; height: 52px;">
            <i class="fa-solid fa-shield-halved fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <h5 class="fw-bold mb-0">{{ rolDetalle.nombre }}</h5>
            <p class="mb-0 small opacity-75">{{ rolDetalle.descripcion }}</p>
          </div>
          <span
            class="badge rounded-pill bg-white bg-opacity-25 text-white fw-bold border border-white border-opacity-25 flex-shrink-0">
            {{ rolDetalle.activo ? '● Activo' : '○ Inactivo' }}
          </span>
        </div>
        <button type="button" class="btn-close btn-close-white ms-3 flex-shrink-0" (click)="cerrarDetalle()"></button>
      </div>

      <!-- Quick Stats -->
      <div class="bg-light border-bottom px-4 py-3">
        <div class="row g-0 text-center">
          <div class="col-4 py-1">
            <div class="fw-bold fs-4 text-dark">{{ rolDetalle.permisos.length }}</div>
            <div class="text-muted text-uppercase fw-bold" style="font-size:0.7rem; letter-spacing:0.05em;">Permisos
            </div>
          </div>
          <div class="col-4 py-1 border-start border-end">
            <div class="fw-bold fs-4 text-dark">{{ permisosDetalleAgrupados(rolDetalle).length }}</div>
            <div class="text-muted text-uppercase fw-bold" style="font-size:0.7rem; letter-spacing:0.05em;">Módulos
            </div>
          </div>
          <div class="col-4 py-1">
            <div class="fw-bold fs-4" [class.text-success]="rolDetalle.activo" [class.text-danger]="!rolDetalle.activo">
              {{ rolDetalle.activo ? 'Activo' : 'Inactivo' }}
            </div>
            <div class="text-muted text-uppercase fw-bold" style="font-size:0.7rem; letter-spacing:0.05em;">Estado</div>
          </div>
        </div>
      </div>

      <!-- Permisos por Categoría -->
      <div class="modal-body p-4" style="max-height: 55vh; overflow-y: auto;">
        <h6 class="fw-bold text-dark mb-4 ps-2 border-start border-4 border-primary">
          Matriz de Permisos Asignados
        </h6>

        <div *ngFor="let grupo of permisosDetalleAgrupados(rolDetalle)" class="mb-4">
          <!-- Category Header -->
          <div class="d-flex align-items-center gap-2 mb-2">
            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
              [style.background-color]="rolDetalle.color + '22'" [style.color]="rolDetalle.color"
              style="width: 28px; height: 28px;">
              <i class="fa-solid fa-layer-group" style="font-size: 0.65rem;"></i>
            </div>
            <span class="fw-bold text-uppercase small text-dark">
              {{ obtenerNombreCategoria(grupo.categoria) }}
            </span>
            <span class="badge rounded-pill ms-auto border fw-normal" [style.border-color]="rolDetalle.color + '55'"
              [style.background-color]="rolDetalle.color + '11'" [style.color]="rolDetalle.color">
              {{ grupo.permisos.length }} permisos
            </span>
          </div>

          <!-- Permission Chips -->
          <div class="d-flex flex-wrap gap-2 ps-4 pb-2 border-bottom border-light">
            <span *ngFor="let permiso of grupo.permisos" class="badge rounded-pill fw-normal py-2 px-3"
              [style.background-color]="rolDetalle.color + '11'" [style.color]="rolDetalle.color"
              style="border: 1px solid; border-color: inherit;">
              <i class="fa-solid fa-check me-1" style="font-size: 0.65rem;"></i>
              {{ obtenerDescripcionPermiso(permiso) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light border-0 py-3 px-4 d-flex gap-2">
        <button type="button" class="btn btn-light border px-4 fw-bold" (click)="cerrarDetalle()">
          Cerrar
        </button>
        <button type="button" class="btn fw-bold px-4 text-white shadow-sm" [style.background-color]="rolDetalle.color"
          (click)="cerrarDetalle(); abrirModalEditar(rolDetalle)">
          <i class="fa-solid fa-pen-to-square me-2"></i> Editar Rol
        </button>
      </div>

    </div>
  </div>
</div>