<div class="container-fluid py-4 bg-light min-vh-100">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h2 class="fw-bold text-dark mb-0">Gestión de Roles</h2>
      <p class="text-muted small mb-0">Define los niveles de acceso y permisos del sistema</p>
    </div>
    <button (click)="abrirModalCrear()" class="btn btn-primary shadow-sm fw-bold">
      <i class="fa-solid fa-shield-halved me-2"></i> Nuevo Rol
    </button>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold small text-muted">Buscar</label>
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0"><i
                class="fa-solid fa-magnifying-glass text-muted"></i></span>
            <input type="text" [(ngModel)]="filtroTexto" (ngModelChange)="aplicarFiltros()"
              class="form-control border-start-0 bg-light" placeholder="Nombre o descripción del rol...">
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold small text-muted">Estado</label>
          <select [(ngModel)]="filtroEstado" (ngModelChange)="aplicarFiltros()" class="form-select bg-light">
            <option value="todos">Todos</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button (click)="filtroTexto = ''; filtroEstado = 'todos'; aplicarFiltros()"
            class="btn btn-light w-100 border text-muted">
            <i class="fa-solid fa-filter-circle-xmark me-2"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Roles Grid -->
  <div class="row g-4">
    <div *ngFor="let rol of rolesFiltrados" class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100 role-card">
        <div class="card-body p-4 d-flex flex-column">

          <!-- Card Header -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center gap-2">
              <div class="role-color-indicator rounded-circle shadow-sm" [style.background-color]="rol.color"></div>
              <h5 class="fw-bold text-dark mb-0">{{ rol.nombre }}</h5>
            </div>
            <span class="badge rounded-pill" [class.bg-success-subtle]="rol.activo" [class.text-success]="rol.activo"
              [class.bg-danger-subtle]="!rol.activo" [class.text-danger]="!rol.activo">
              {{ rol.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </div>

          <p class="text-muted small mb-4 flex-grow-1">{{ rol.descripcion }}</p>

          <!-- Stats -->
          <div class="row g-2 mb-4">
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center border border-light">
                <h4 class="fw-bold text-primary mb-0">{{ rol.permisos.length }}</h4>
                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Permisos</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center border border-light">
                <h4 class="fw-bold text-success mb-0">{{ contarUsuariosConRol(rol.id!) }}</h4>
                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Usuarios</small>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="d-flex justify-content-between align-items-center pt-3 border-top">
            <button (click)="verDetallesRol(rol)" class="btn btn-link text-decoration-none p-0 fw-bold small">
              Ver Detalles <i class="fa-solid fa-arrow-right ms-1"></i>
            </button>

            <div class="btn-group">
              <button (click)="abrirModalEditar(rol)" class="btn btn-sm btn-light text-primary border-0" title="Editar">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>
              <button (click)="cambiarEstadoRol(rol)" class="btn btn-sm btn-light border-0"
                [class.text-danger]="rol.activo" [class.text-success]="!rol.activo"
                [title]="rol.activo ? 'Desactivar' : 'Activar'">
                <i class="fa-solid" [class.fa-toggle-on]="rol.activo" [class.fa-toggle-off]="!rol.activo"></i>
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="rolesFiltrados.length === 0" class="text-center py-5">
    <div class="text-muted opacity-50 mb-3">
      <i class="fa-solid fa-user-shield display-4"></i>
    </div>
    <h5 class="text-dark fw-bold">No se encontraron roles</h5>
    <p class="text-muted small">Intenta ajustar los filtros de búsqueda</p>
  </div>

</div>


<!-- MODAL: CREAR/EDITAR ROL (Standardized Premium Design) -->
<div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-card" style="max-width: 950px;" (click)="$event.stopPropagation()">

    <!-- Premium Header -->
    <div class="modal-header bg-premium-blue text-white">
      <div class="d-flex align-items-center gap-3">
        <div class="premium-icon-box shadow-lg">
          <i class="fa-solid fs-4 text-white" [class.fa-shield-halved]="modoModal === 'crear'"
            [class.fa-user-shield]="modoModal !== 'crear'"></i>
        </div>
        <div>
          <h5 class="modal-title fw-bold mb-0">
            {{ modoModal === 'crear' ? 'Nuevo Rol de Sistema' : 'Editar Rol' }}
          </h5>
          <p class="mb-0 small text-white-50">Define los niveles de acceso y permisos</p>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
    </div>

    <div class="modal-body p-0 custom-scrollbar" style="overflow-y: auto; flex: 1;">
      <form (ngSubmit)="guardarRol()" #rolForm="ngForm">
        <div class="row g-0">

          <!-- Left Sidebar: Basic Config -->
          <div class="col-lg-4 bg-light p-4 border-end d-flex flex-column">
            <h6 class="fw-bold text-dark mb-4 ps-1 border-start border-4 border-primary ps-2">Configuración General
            </h6>

            <div class="form-floating mb-3">
              <input type="text" [(ngModel)]="formularioRol.nombre" name="nombre" required
                class="form-control bg-white shadow-sm" id="floatRolName" placeholder="Nombre">
              <label for="floatRolName">Nombre del Rol *</label>
            </div>

            <div class="form-floating mb-4">
              <textarea [(ngModel)]="formularioRol.descripcion" name="descripcion" required
                class="form-control bg-white shadow-sm" id="floatDesc" placeholder="Desc"
                style="height: 100px"></textarea>
              <label for="floatDesc">Descripción *</label>
            </div>

            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body p-3">
                <label class="form-label fw-bold small text-muted text-uppercase mb-2">Color de Identificación</label>
                <div class="d-flex flex-wrap gap-2 mb-3">
                  <button *ngFor="let color of coloresPredefinidos" type="button" (click)="formularioRol.color = color"
                    class="btn p-0 rounded-circle border-2 transition-transform hover-scale"
                    [style.background-color]="color" [class.border-dark]="formularioRol.color === color"
                    [class.border-white]="formularioRol.color !== color"
                    style="width: 28px; height: 28px; box-shadow: 0 0 0 1px #dee2e6;">
                  </button>
                </div>
                <input type="color" [(ngModel)]="formularioRol.color" name="color"
                  class="form-control form-control-color w-100 border-0 bg-light p-0"
                  title="Elige un color personalizado" style="height: 38px;">
              </div>
            </div>

            <div class="mt-auto">
              <div class="card bg-white border-0 shadow-sm">
                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="fw-bold text-dark mb-0">Estado del Rol</h6>
                    <small class="text-muted small lh-sm d-block">{{ formularioRol.activo ? 'Visible y asignable' :
                      'Oculto para nuevos usuarios' }}</small>
                  </div>
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input fs-5 ms-0" type="checkbox" role="switch" id="activoCheck"
                      [(ngModel)]="formularioRol.activo" name="activo">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Content: Permissions Matrix -->
          <div class="col-lg-8 p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h6 class="fw-bold text-dark mb-0 ps-1 border-start border-4 border-success ps-2">
                Permisos Asignados
                <span class="badge bg-success rounded-pill ms-2 fw-bold shadow-sm" style="font-size: 0.85rem;">{{
                  formularioRol.permisos.length }}</span>
              </h6>
              <div class="text-end d-none d-md-block">
                <small class="text-muted fw-medium">Selecciona los módulos con acceso</small>
              </div>
            </div>

            <div class="permissions-container custom-scrollbar pe-2" style="max-height: 320px; overflow-y: auto;">
              <div *ngFor="let categoria of Object.keys(permisosAgrupados)" class="mb-4">
                <div class="d-flex align-items-center p-2 rounded bg-light mb-2 border-start border-3"
                  [style.border-color]="categoriaEsCompleta(categoria) ? '#198754' : '#dee2e6'">
                  <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" [checked]="categoriaEsCompleta(categoria)"
                      [indeterminate]="categoriaTienePermisos(categoria) && !categoriaEsCompleta(categoria)"
                      (change)="toggleCategoria(categoria)" [id]="'cat_' + categoria">
                    <label class="form-check-label fw-bold text-dark text-uppercase small ms-1"
                      [for]="'cat_' + categoria" style="letter-spacing: 0.03em;">
                      {{ obtenerNombreCategoria(categoria) }}
                    </label>
                  </div>
                </div>

                <div class="row g-2 ps-3">
                  <div *ngFor="let permiso of Object.keys(permisosAgrupados[categoria])" class="col-md-6 col-xl-4">
                    <label class="permission-card card h-100 border shadow-sm cursor-pointer transition-all"
                      [class.border-primary]="tienePermiso(permiso)" [class.bg-primary-subtle]="tienePermiso(permiso)"
                      style="border-radius: 10px;">
                      <div class="card-body p-2 d-flex align-items-start gap-2">
                        <input class="form-check-input mt-1 flex-shrink-0" type="checkbox"
                          [checked]="tienePermiso(permiso)" (change)="togglePermiso(permiso)" [id]="'perm_' + permiso">
                        <div class="small lh-sm" [class.fw-bold]="tienePermiso(permiso)"
                          [class.text-primary]="tienePermiso(permiso)" [class.text-dark]="!tienePermiso(permiso)">
                          {{ permisosAgrupados[categoria][permiso] }}
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>


          </div>

        </div>
      </form>
    </div>

    <!-- Footer fijo con botones SIEMPRE visible -->
    <div class="modal-footer bg-white border-top px-4 py-3 d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-light px-4 border shadow-sm fw-bold text-muted"
        (click)="cerrarModal()">Cancelar</button>
      <button type="button" [disabled]="isSaving" (click)="guardarRol()"
        class="btn btn-primary px-4 fw-bold shadow-sm d-flex align-items-center gap-2" style="border-radius: 12px;">
        @if (isSaving) {
        <span class="spinner-border spinner-border-sm"></span> Guardando...
        } @else {
        <i class="fa-solid fa-floppy-disk"></i> {{ modoModal === 'crear' ? 'Crear Rol' : 'Guardar Cambios' }}
        }
      </button>
    </div>

  </div>
</div>


<!-- MODAL: DETALLE DE ROL (Standardized LogosPOS Design) -->
<div *ngIf="mostrarDetalle && rolDetalle" class="modal-overlay" (click)="cerrarDetalle()">
  <div class="modal-card" style="max-width: 850px;" (click)="$event.stopPropagation()">

    <!-- Premium Solid Blue & Glassmorphism Header -->
    <div class="modal-header bg-premium-blue text-white">
      <!-- Subtle Pattern Overlay (optional CSS or inline) -->

      <div class="d-flex align-items-center gap-3 position-relative z-1">
        <div class="premium-icon-box shadow-lg">
          <i class="fa-solid fa-shield-halved fs-4 text-white"></i>
        </div>
        <div>
          <h4 class="fw-bold mb-0">Detalles del Rol</h4>
          <p class="text-white-50 small mb-0 fw-medium">Configuración de privilegios administrativos</p>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white position-relative z-1" (click)="cerrarDetalle()"></button>
    </div>

    <!-- Role Identity & Status Banner -->
    <div class="px-4 py-3 border-bottom d-flex align-items-center justify-content-between bg-white">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle" style="width: 12px; height: 12px;" [style.background-color]="rolDetalle.color">
        </div>
        <h3 class="fw-bold text-slate-800 mb-0">{{ rolDetalle.nombre }}</h3>
        <span class="badge rounded-pill fw-bold border-0 px-3 py-2"
          [style.background-color]="rolDetalle.activo ? '#dcfce7' : '#fee2e2'"
          [style.color]="rolDetalle.activo ? '#15803d' : '#b91c1c'">
          {{ rolDetalle.activo ? '● ACTIVO' : '○ INACTIVO' }}
        </span>
      </div>
      <div class="text-end d-none d-md-block">
        <p class="text-slate-500 small mb-0">{{ rolDetalle.descripcion }}</p>
      </div>
    </div>

    <!-- Scrollable content -->
    <div class="modal-body custom-scrollbar bg-white" style="max-height: 60vh; overflow-y: auto;">

      <!-- Premium Stats Cards -->
      <div class="row g-3 mb-5 px-1">
        <div class="col-6 col-md-3">
          <div class="stat-card-premium h-100 text-center">
            <div class="text-primary mb-2"><i class="fa-solid fa-key fs-4"></i></div>
            <div class="fw-bold fs-4 text-slate-800">{{ rolDetalle.permisos.length }}</div>
            <div class="text-slate-500 text-uppercase fw-bold" style="font-size:0.65rem;">Permisos</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card-premium h-100 text-center">
            <div class="text-dark mb-2"><i class="fa-solid fa-layer-group fs-4"></i></div>
            <div class="fw-bold fs-4 text-slate-800">{{ permisosDetalleAgrupados(rolDetalle).length }}</div>
            <div class="text-slate-500 text-uppercase fw-bold" style="font-size:0.65rem;">Módulos</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card-premium h-100 text-center">
            <div class="text-success mb-2"><i class="fa-solid fa-calendar-check fs-4"></i></div>
            <div class="fw-bold fs-4 text-slate-800">{{ rolDetalle.created_at | date:'dd/MM' }}</div>
            <div class="text-slate-500 text-uppercase fw-bold" style="font-size:0.65rem;">Creado</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card-premium h-100 text-center">
            <div class="text-warning mb-2"><i class="fa-solid fa-user-shield fs-4"></i></div>
            <div class="fw-bold fs-4 text-slate-800">{{ contarUsuariosConRol(rolSeleccionado?.id || 0) }}</div>
            <div class="text-slate-500 text-uppercase fw-bold" style="font-size:0.65rem;">Usuarios</div>
          </div>
        </div>
      </div>

      <!-- Module-based Permissions Grid -->
      <div class="px-1">
        <div *ngFor="let grupo of permisosDetalleAgrupados(rolDetalle)"
          class="mb-5 animate__animated animate__fadeInUp animate__faster">
          <!-- Premium Module Header -->
          <div class="permission-module-header shadow-sm">
            <div class="d-flex align-items-center gap-3">
              <div class="text-primary fw-bold" style="width: 24px;"><i class="fa-solid fa-circle-dot"></i></div>
              <h6 class="fw-bold text-slate-800 text-uppercase mb-0"
                style="letter-spacing: 0.05em; font-size: 0.85rem;">
                {{ obtenerNombreCategoria(grupo.categoria) }}
              </h6>
            </div>
            <span class="badge bg-white text-primary border shadow-sm rounded-pill px-3 py-2 fw-bold"
              style="font-size: 0.75rem;">
              {{ grupo.permisos.length }} Acciones
            </span>
          </div>

          <!-- Premium Tags Grid -->
          <div class="d-flex flex-wrap gap-2 ps-2">
            <span *ngFor="let permiso of grupo.permisos" class="permission-tag-premium shadow-sm">
              <i class="fa-solid fa-check-circle" [style.color]="rolDetalle.color"></i>
              {{ obtenerDescripcionPermiso(permiso) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Standard Premium Footer -->
    <div class="modal-footer bg-light border-top-0 p-4 d-flex justify-content-end gap-3">
      <button type="button" class="btn btn-light border-0 px-4 py-2 fw-bold text-slate-500" (click)="cerrarDetalle()">
        Cerrar
      </button>
      <button type="button" class="btn btn-primary px-5 py-2 fw-bold shadow-sm d-flex align-items-center gap-2"
        style="border-radius: 12px;" (click)="abrirModalEditar(rolDetalle!); cerrarDetalle()">
        <i class="fa-solid fa-pen-to-square"></i>
        <span>EDITAR CONFIGURACIÓN</span>
      </button>
    </div>

  </div>
</div>