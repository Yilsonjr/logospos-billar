<div class="container-fluid py-4 bg-light min-vh-100">

  <!-- Header -->
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h2 class="fw-bold text-dark mb-0">
        <i class="fa-solid fa-microchip me-2 text-primary"></i>Panel de Sistema
      </h2>
      <p class="text-muted small mb-0">Estado operativo, salud de la plataforma y herramientas de mantenimiento</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2 fw-bold">
        <i class="fa-solid fa-circle-dot me-1 fa-beat" style="--fa-beat-scale: 1.2;"></i> Sistema Operativo
      </span>
      <button (click)="verificarEstado()" [disabled]="isLoading"
        class="btn btn-light border shadow-sm rounded-pill px-3">
        <i class="fa-solid fa-rotate me-1" [class.fa-spin]="isLoading"></i> Actualizar
      </button>
    </div>
  </div>

  <!-- ====== Salud del Sistema ====== -->
  <div class="row g-4 mb-4">

    <!-- Conexión BD -->
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 rounded-4">
        <div class="card-body p-4 d-flex flex-column justify-content-between">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div style="background:#dcfce7; color:#16a34a; padding:12px; border-radius:12px;">
              <i class="fa-solid fa-database fs-4"></i>
            </div>
            <span class="badge rounded-pill fw-bold"
              style="background:#dcfce7; color:#16a34a; border:1px solid #86efac; font-size:0.75rem; padding:5px 10px;">
              OK
            </span>
          </div>
          <div>
            <div class="text-muted small fw-bold text-uppercase mb-1" style="letter-spacing:0.05em;">Base de Datos</div>
            <h5 class="fw-bold text-dark mb-0">Conectada</h5>
            <small class="text-muted">Supabase PostgreSQL</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Roles del Sistema -->
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 rounded-4">
        <div class="card-body p-4 d-flex flex-column justify-content-between">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div [style.background]="estadoSistema.rolesCreados ? '#dcfce7' : '#fee2e2'"
              [style.color]="estadoSistema.rolesCreados ? '#16a34a' : '#dc2626'"
              style="padding:12px; border-radius:12px;">
              <i class="fa-solid fa-shield-halved fs-4"></i>
            </div>
            <span class="badge rounded-pill fw-bold"
              [style.background]="estadoSistema.rolesCreados ? '#dcfce7' : '#fee2e2'"
              [style.color]="estadoSistema.rolesCreados ? '#16a34a' : '#dc2626'"
              [style.border-color]="estadoSistema.rolesCreados ? '#86efac' : '#fca5a5'"
              style="border:1px solid; font-size:0.75rem; padding:5px 10px;">
              {{ estadoSistema.rolesCreados ? 'OK' : 'ERROR' }}
            </span>
          </div>
          <div>
            <div class="text-muted small fw-bold text-uppercase mb-1" style="letter-spacing:0.05em;">Matriz de Roles
            </div>
            <h5 class="fw-bold text-dark mb-0">{{ estadoSistema.rolesCreados ? 'Configurada' : 'Sin configurar' }}</h5>
            <small class="text-muted">{{ estadoSistema.rolesCreados ? 'Permisos activos' : 'Requiere atención'
              }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Administrador -->
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 rounded-4">
        <div class="card-body p-4 d-flex flex-column justify-content-between">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div [style.background]="estadoSistema.adminCreado ? '#dbeafe' : '#fee2e2'"
              [style.color]="estadoSistema.adminCreado ? '#2563eb' : '#dc2626'"
              style="padding:12px; border-radius:12px;">
              <i class="fa-solid fa-user-shield fs-4"></i>
            </div>
            <span class="badge rounded-pill fw-bold"
              [style.background]="estadoSistema.adminCreado ? '#dbeafe' : '#fee2e2'"
              [style.color]="estadoSistema.adminCreado ? '#2563eb' : '#dc2626'"
              [style.border-color]="estadoSistema.adminCreado ? '#93c5fd' : '#fca5a5'"
              style="border:1px solid; font-size:0.75rem; padding:5px 10px;">
              {{ estadoSistema.adminCreado ? 'OK' : 'ERROR' }}
            </span>
          </div>
          <div>
            <div class="text-muted small fw-bold text-uppercase mb-1" style="letter-spacing:0.05em;">Super Admin</div>
            <h5 class="fw-bold text-dark mb-0">{{ estadoSistema.adminCreado ? 'Detectado' : 'No encontrado' }}</h5>
            <small class="text-muted">Cuenta principal del sistema</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Total usuarios -->
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 rounded-4"
        style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
        <div class="card-body p-4 d-flex flex-column justify-content-between">
          <div class="mb-3">
            <div style="background: rgba(255,255,255,0.18); border-radius:12px; padding:12px;
                        width:52px; height:52px; display:flex; align-items:center; justify-content:center;">
              <i class="fa-solid fa-users fs-4" style="color:white;"></i>
            </div>
          </div>
          <div>
            <div class="small fw-bold text-uppercase mb-1" style="letter-spacing:0.05em; color:rgba(255,255,255,0.7);">
              Usuarios Totales</div>
            <h2 class="fw-bold mb-0" style="color:white;">{{ estadoSistema.usuariosDemo }}</h2>
            <small style="color:rgba(255,255,255,0.7);">Cuentas registradas</small>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ====== Información del Entorno ====== -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body p-4">
      <h6 class="fw-bold text-dark mb-4 ps-2 border-start border-4 border-primary">
        Información del Entorno
      </h6>
      <div class="row g-3">
        <div class="col-md-3 col-6">
          <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Aplicación</div>
          <div class="fw-bold text-dark">LicorPos</div>
        </div>
        <div class="col-md-3 col-6">
          <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Versión</div>
          <div class="fw-bold text-dark">
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">v1.0.0</span>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Motor de BD</div>
          <div class="fw-bold text-dark">PostgreSQL 15</div>
        </div>
        <div class="col-md-3 col-6">
          <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Entorno</div>
          <div class="fw-bold text-dark">
            <span class="badge bg-warning-subtle text-warning border border-warning-subtle">Desarrollo</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Herramientas de Mantenimiento ====== -->
  <h6 class="fw-bold text-dark mb-3 ps-3 border-start border-4 border-warning">
    Herramientas de Mantenimiento
  </h6>
  <div class="row g-4 mb-4">

    <!-- Reconstruir Roles -->
    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-body p-4 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-3 flex-shrink-0">
              <i class="fa-solid fa-screwdriver-wrench fs-4"></i>
            </div>
            <div>
              <h6 class="fw-bold mb-0">Reconstruir Roles</h6>
              <small class="text-muted">Regenera la matriz de permisos base</small>
            </div>
          </div>
          <p class="text-muted small flex-grow-1">
            Verifica y recrea los roles del sistema si están incompletos o dañados.
            No elimina datos existentes.
          </p>
          <button (click)="reinicializarSistema()" [disabled]="isLoading"
            class="btn btn-warning text-white fw-bold rounded-pill py-2 shadow-sm mt-2">
            <i class="fa-solid fa-arrows-rotate me-2"></i> Ejecutar
          </button>
        </div>
      </div>
    </div>

    <!-- Cerrar Sesiones Expiradas -->
    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-body p-4 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="bg-danger bg-opacity-10 text-danger p-3 rounded-3 flex-shrink-0">
              <i class="fa-solid fa-right-from-bracket fs-4"></i>
            </div>
            <div>
              <h6 class="fw-bold mb-0">Limpiar Sesiones</h6>
              <small class="text-muted">Purga sesiones inactivas</small>
            </div>
          </div>
          <p class="text-muted small flex-grow-1">
            Cierra y elimina todas las sesiones de usuarios que están inactivas o han expirado.
            Los usuarios activos no se ven afectados.
          </p>
          <button (click)="limpiarSesiones()" [disabled]="isLoading"
            class="btn btn-danger fw-bold rounded-pill py-2 shadow-sm mt-2">
            <i class="fa-solid fa-broom me-2"></i> Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Verificar Integridad -->
    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-body p-4 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="bg-info bg-opacity-10 text-info p-3 rounded-3 flex-shrink-0">
              <i class="fa-solid fa-stethoscope fs-4"></i>
            </div>
            <div>
              <h6 class="fw-bold mb-0">Diagnóstico</h6>
              <small class="text-muted">Verifica integridad del sistema</small>
            </div>
          </div>
          <p class="text-muted small flex-grow-1">
            Ejecuta una verificación completa del estado del sistema: roles, usuario admin
            y estructura de permisos.
          </p>
          <button (click)="verificarEstado()" [disabled]="isLoading"
            class="btn btn-info text-white fw-bold rounded-pill py-2 shadow-sm mt-2">
            <i class="fa-solid fa-heart-pulse me-2"></i> Verificar
          </button>
        </div>
      </div>
    </div>

    <!-- Copia de Seguridad -->
    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100"
        style="background: linear-gradient(145deg, #f0fdf4, #ffffff);">
        <div class="card-body p-4 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="bg-success bg-opacity-10 text-success p-3 rounded-3 flex-shrink-0">
              <i class="fa-solid fa-box-archive fs-4"></i>
            </div>
            <div>
              <h6 class="fw-bold mb-0 text-success">Copia de Seguridad</h6>
              <small class="text-muted">Exportar todos los datos</small>
            </div>
          </div>
          <p class="text-muted small flex-grow-1">
            Descarga un archivo <strong>.json</strong> con todos los datos críticos del sistema:
            productos, ventas, clientes, cuentas, usuarios y configuración fiscal.
          </p>
          <div class="d-flex gap-2 mt-2">
            <button (click)="generarBackup()" [disabled]="isBackingUp || isLoading"
              class="btn btn-success fw-bold rounded-pill py-2 shadow-sm flex-grow-1">
              @if (isBackingUp) {
              <span class="spinner-border spinner-border-sm me-2"></span> Exportando...
              } @else {
              <i class="fa-solid fa-download me-2"></i> Descargar Backup
              }
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ====== Alerta de Seguridad ====== -->
  <div class="card border-0 shadow-sm rounded-4 border-start border-4 border-danger bg-white mb-4">
    <div class="card-body p-4">
      <div class="d-flex gap-4 align-items-start">
        <div
          class="bg-danger bg-opacity-10 text-danger p-3 rounded-3 flex-shrink-0 d-flex align-items-center justify-content-center"
          style="width: 56px; height: 56px;">
          <i class="fa-solid fa-triangle-exclamation fs-4"></i>
        </div>
        <div>
          <h6 class="fw-bold text-dark mb-1">Zona de Operaciones Críticas</h6>
          <p class="small text-muted mb-0">
            Las herramientas de este panel afectan la integridad estructural del sistema en tiempo real.
            Los cambios en la matriz de roles impactan inmediatamente a todos los usuarios vinculados.
            <strong>Realiza un respaldo antes de cualquier operación masiva.</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Nota de Producción ====== -->
  <div class="card border-0 rounded-4 mb-0"
    style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-left: 4px solid #22c55e !important;">
    <div class="card-body p-4">
      <div class="d-flex gap-3 align-items-start">
        <div class="text-success fs-4 flex-shrink-0 pt-1">
          <i class="fa-solid fa-circle-info"></i>
        </div>
        <div>
          <h6 class="fw-bold text-success mb-2">Nota para Puesta en Producción</h6>
          <ul class="mb-0 small text-muted ps-3">
            <li>Cambia el badge de entorno de <strong>"Desarrollo"</strong> a <strong>"Producción"</strong></li>
            <li>Gestiona los usuarios del sistema desde <strong>Administración → Usuarios</strong></li>
            <li>Los usuarios nuevos se crean directamente con rol asignado, sin perfiles demo</li>
            <li>Revisa la <strong>Configuración Fiscal</strong> antes de procesar ventas reales</li>
            <li>Configura las secuencias NCF si usas facturación con comprobantes fiscales</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>