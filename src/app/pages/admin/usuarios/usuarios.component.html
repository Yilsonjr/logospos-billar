<div class="container-fluid py-4 bg-light min-vh-100">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h2 class="fw-bold text-dark mb-0">Gestión de Usuarios</h2>
      <p class="text-muted small mb-0">Administra los accesos y roles del sistema</p>
    </div>
    <button (click)="abrirModalCrear()" class="btn btn-primary shadow-sm fw-bold">
      <i class="fa-solid fa-user-plus me-2"></i> Nuevo Usuario
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 p-3">
        <div class="d-flex align-items-center">
          <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3 me-3">
            <i class="fa-solid fa-users fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted small text-uppercase mb-1">Total Usuarios</h6>
            <h3 class="fw-bold mb-0 text-dark">{{ estadisticas.total }}</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 p-3">
        <div class="d-flex align-items-center">
          <div class="bg-success bg-opacity-10 text-success rounded-circle p-3 me-3">
            <i class="fa-solid fa-user-check fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted small text-uppercase mb-1">Activos</h6>
            <h3 class="fw-bold mb-0 text-success">{{ estadisticas.activos }}</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 p-3">
        <div class="d-flex align-items-center">
          <div class="bg-danger bg-opacity-10 text-danger rounded-circle p-3 me-3">
            <i class="fa-solid fa-user-xmark fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted small text-uppercase mb-1">Inactivos</h6>
            <h3 class="fw-bold mb-0 text-danger">{{ estadisticas.inactivos }}</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 p-3">
        <div class="d-flex align-items-center">
          <div class="bg-info bg-opacity-10 text-info rounded-circle p-3 me-3">
            <i class="fa-solid fa-user-tag fs-4"></i>
          </div>
          <div>
            <h6 class="text-muted small text-uppercase mb-1">Roles Definidos</h6>
            <h3 class="fw-bold mb-0 text-info">{{ roles.length }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters & View Switcher -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
      <div class="row g-3 align-items-center">
        <!-- Search -->
        <div class="col-md-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-light border-end-0 text-muted">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
            <input type="text" [(ngModel)]="filtroTexto" (ngModelChange)="aplicarFiltros()"
              class="form-control border-start-0 bg-light-subtle ps-0" placeholder="Nombre, email, usuario...">
          </div>
        </div>

        <!-- Role Filter -->
        <div class="col-md-3">
          <select [(ngModel)]="filtroRol" (ngModelChange)="aplicarFiltros()"
            class="form-select form-select-sm bg-light-subtle border-0 rounded-pill px-3">
            <option value="">Todos los roles</option>
            <option *ngFor="let rol of roles" [value]="rol.id">{{ rol.nombre }}</option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="col-md-3">
          <select [(ngModel)]="filtroEstado" (ngModelChange)="aplicarFiltros()"
            class="form-select form-select-sm bg-light-subtle border-0 rounded-pill px-3">
            <option value="todos">Todos los estados</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>

        <!-- View Switcher -->
        <div class="col-md-2 text-end">
          <div class="btn-group btn-group-sm shadow-sm rounded-pill overflow-hidden border">
            <button class="btn border-0 py-1 px-3" [class.btn-primary]="vistaActual === 'tarjetas'"
              [class.btn-light]="vistaActual !== 'tarjetas'" (click)="cambiarVista('tarjetas')">
              <i class="fa-solid fa-grip-vertical"></i>
            </button>
            <button class="btn border-0 py-1 px-3" [class.btn-primary]="vistaActual === 'tabla'"
              [class.btn-light]="vistaActual !== 'tabla'" (click)="cambiarVista('tabla')">
              <i class="fa-solid fa-list-ul"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>


  @if (isLoading && usuariosFiltrados.length === 0) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted small letter-spacing-1 text-uppercase">Sincronizando equipo...</p>
  </div>
  } @else {

  <!-- Vista Tarjetas -->
  @if (vistaActual === 'tarjetas') {
  <div class="row g-4 mb-4">
    @for (usuario of usuariosFiltrados; track usuario.id) {
    <div class="col-md-6 col-lg-4 col-xl-3">
      <div class="card h-100 border-0 shadow-sm user-card transition-all position-relative overflow-visible">
        <!-- Badge Estado -->
        <div class="position-absolute top-0 start-0 m-3 z-1">
          <span class="badge rounded-pill shadow-sm" [class.bg-success]="usuario.activo"
            [class.bg-danger]="!usuario.activo" style="width: 10px; height: 10px; padding: 0; display: block;"
            [title]="usuario.activo ? 'Activo' : 'Inactivo'">
          </span>
        </div>

        <!-- Menu Acciones -->
        <div class="position-absolute top-0 end-0 m-2 z-2 dropdown">
          <button
            class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center border-0 shadow-sm"
            (click)="toggleMenu($event, usuario.id!)" style="width: 30px; height: 30px;">
            <i class="fa-solid fa-ellipsis-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow border-0 py-2" [class.show]="menuAbiertoId === usuario.id"
            style="position: absolute; right: 0; left: auto; margin-top: 5px; min-width: 180px;">
            <li><button class="dropdown-item py-2" (click)="abrirModalEditar(usuario)"><i
                  class="fa-solid fa-user-pen me-2 text-primary"></i>Editar Perfil</button></li>
            <li><button class="dropdown-item py-2" (click)="resetearContrasena(usuario)"><i
                  class="fa-solid fa-key me-2 text-warning"></i>Cambiar Clave</button></li>
            <li>
              <hr class="dropdown-divider opacity-50">
            </li>
            <li>
              <button class="dropdown-item py-2" [class.text-danger]="usuario.activo"
                [class.text-success]="!usuario.activo" (click)="cambiarEstadoUsuario(usuario)">
                <i class="fa-solid me-2" [class.fa-user-slash]="usuario.activo"
                  [class.fa-user-check]="!usuario.activo"></i>
                {{ usuario.activo ? 'Desactivar Acceso' : 'Habilitar Acceso' }}
              </button>
            </li>
          </ul>
        </div>

        <div class="card-body text-center pt-4 pb-3">
          <!-- Avatar -->
          <div class="mx-auto mb-3 position-relative" style="width: 80px;">
            <div
              class="avatar-circle-lg rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center fw-bold fs-3 border-2 border-white shadow-sm"
              style="width: 80px; height: 80px;">
              {{ usuario.nombre.charAt(0) }}{{ usuario.apellido.charAt(0) }}
            </div>
            @if (usuario.rol_id === 1) {
            <div
              class="position-absolute bottom-0 end-0 bg-warning rounded-circle d-flex align-items-center justify-content-center shadow-sm"
              style="width: 24px; height: 24px; border: 2px solid #fff;" title="Administrador">
              <i class="fa-solid fa-crown text-white" style="font-size: 0.7rem;"></i>
            </div>
            }
          </div>

          <h5 class="fw-bold mb-1 text-dark text-truncate px-2">{{ usuario.nombre }} {{ usuario.apellido }}</h5>
          <div class="text-primary small fw-semibold opacity-75 mb-2">@{{ usuario.username }}</div>

          <div class="px-3">
            <span class="badge rounded-pill fw-normal w-100 py-1 border"
              [style.background-color]="obtenerColorRol(usuario.rol_id) + '15'"
              [style.color]="obtenerColorRol(usuario.rol_id)"
              [style.border-color]="obtenerColorRol(usuario.rol_id) + '40'">
              {{ obtenerNombreRol(usuario.rol_id) }}
            </span>
          </div>
        </div>

        <div class="card-footer bg-light-subtle border-0 px-3 pb-3 pt-0">
          <div class="d-flex align-items-center justify-content-center gap-4 text-muted border-top pt-3"
            style="font-size: 0.75rem;">
            <div class="text-center">
              <i class="fa-regular fa-clock d-block mb-1"></i>
              {{ usuario.ultimo_acceso ? (usuario.ultimo_acceso | date:'shortDate') : 'Sin acceso' }}
            </div>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
  }

  <!-- Vista Tabla -->
  @if (vistaActual === 'tabla') {
  <div class="card border-0 shadow-sm overflow-hidden mb-4">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-white border-bottom shadow-sm">
          <tr>
            <th class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">Colaborador</th>
            <th class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">Rol</th>
            <th class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">Estado</th>
            <th class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">Última Actividad</th>
            <th class="py-3 px-4 text-end text-muted small fw-bold text-uppercase border-0 pe-5">Gestión</th>
          </tr>
        </thead>
        <tbody class="border-top-0">
          @for (usuario of usuariosFiltrados; track usuario.id) {
          <tr class="border-bottom-light transition-all">
            <td class="px-4 py-3">
              <div class="d-flex align-items-center">
                <div
                  class="avatar-circle rounded-circle bg-light text-primary fw-bold d-flex align-items-center justify-content-center me-3 border shadow-sm"
                  style="width: 42px; height: 42px; min-width: 42px;">
                  {{ usuario.nombre.charAt(0) }}{{ usuario.apellido.charAt(0) }}
                </div>
                <div>
                  <div class="fw-bold text-dark mb-0">{{ usuario.nombre }} {{ usuario.apellido }}</div>
                  <div class="small text-muted opacity-75">{{ usuario.email }}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3">
              <span class="badge rounded-pill px-3 py-1 font-monospace fw-normal"
                [style.background-color]="obtenerColorRol(usuario.rol_id) + '15'"
                [style.color]="obtenerColorRol(usuario.rol_id)">
                {{ obtenerNombreRol(usuario.rol_id) }}
              </span>
            </td>
            <td class="px-4 py-3">
              <span class="d-flex align-items-center gap-2">
                <span class="status-dot shadow-sm" [class.bg-success]="usuario.activo"
                  [class.bg-danger]="!usuario.activo"></span>
                <span class="small fw-semibold" [class.text-success]="usuario.activo"
                  [class.text-danger]="!usuario.activo">
                  {{ usuario.activo ? 'ACTIVO' : 'INACTIVO' }}
                </span>
              </span>
            </td>
            <td class="px-4 py-3 text-muted small">
              {{ formatearFecha(usuario.ultimo_acceso) }}
            </td>
            <td class="px-4 py-3 text-end pe-4">
              <div class="btn-group shadow-sm rounded-pill overflow-hidden border">
                <button (click)="abrirModalEditar(usuario)" class="btn btn-sm btn-white border-0 py-1 px-3 text-primary"
                  title="Editar">
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button (click)="resetearContrasena(usuario)"
                  class="btn btn-sm btn-white border-0 py-1 px-3 text-warning" title="Clave">
                  <i class="fa-solid fa-key"></i>
                </button>
                <button (click)="cambiarEstadoUsuario(usuario)" class="btn btn-sm btn-white border-0 py-1 px-3"
                  [class.text-danger]="usuario.activo" [class.text-success]="!usuario.activo"
                  [title]="usuario.activo ? 'Desactivar' : 'Activar'">
                  <i class="fa-solid" [class.fa-user-slash]="usuario.activo"
                    [class.fa-user-check]="!usuario.activo"></i>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  <!-- Empty State -->
  @if (usuariosFiltrados.length === 0) {
  <div class="card border-0 shadow-sm rounded-4 py-5 text-center">
    <div class="text-muted opacity-25 mb-4">
      <i class="fa-solid fa-users-viewfinder display-1"></i>
    </div>
    <h4 class="fw-bold text-dark">Sin resultados</h4>
    <p class="text-muted small px-5">No encontramos usuarios que coincidan con "{{ filtroTexto }}". Prueba con otros
      filtros.</p>
    <div>
      <button (click)="filtroTexto = ''; filtroRol = ''; filtroEstado = 'todos'; aplicarFiltros()"
        class="btn btn-outline-primary btn-sm rounded-pill px-4">
        Restablecer Búsqueda
      </button>
    </div>
  </div>
  }
  }


</div>

<!-- Modal (Bootstrap Style - Premium Refined) -->
<div *ngIf="mostrarModal" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg overflow-hidden">

      <!-- Premium Header -->
      <div class="modal-header bg-gradient-primary text-white border-bottom-0 py-2 px-2">
        <div class="d-flex align-items-center gap-3">
          <div
            class="bg-white bg-opacity-25 rounded-circle p-3 d-flex align-items-center justify-content-center shadow-inner"
            style="width: 56px; height: 56px;">
            <i class="fa-solid fs-3" [class.fa-user-plus]="modoModal === 'crear'"
              [class.fa-user-pen]="modoModal !== 'crear'"></i>
          </div>
          <div>
            <h4 class="modal-title fw-bold mb-0">
              {{ modoModal === 'crear' ? 'Nuevo Usuario' : 'Editar Perfil' }}
            </h4>
            <p class="mb-0 text-white-50 small">Configura la información personal y credenciales</p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <div class="modal-body p-0">
        <form (ngSubmit)="guardarUsuario()" #usuarioForm="ngForm">

          <div class="row g-0">
            <!-- Left Sidebar: Profile & Status -->
            <div class="col-lg-4 bg-light p-2 border-end d-flex flex-column align-items-center text-center">

              <div class="position-relative mb-4 mt-2">
                <div
                  class="avatar-placeholder rounded-circle bg-white shadow-sm border-2 border-primary border-opacity-25 d-flex align-items-center justify-content-center text-primary display-4 gradient-text"
                  style="width: 140px; height: 140px;">
                  {{ formularioUsuario.nombre.charAt(0) || 'U' }}
                </div>
                <!-- Camera Button Hover Effect -->
                <button type="button"
                  class="btn btn-primary rounded-circle position-absolute bottom-0 end-0 shadow border-4 border-white btn-camera"
                  title="Subir foto">
                  <i class="fa-solid fa-camera small"></i>
                </button>
              </div>

              <h5 class="fw-bold text-dark mb-1">{{ formularioUsuario.nombre || 'Nuevo Usuario' }}</h5>
              <div class="text-muted small mb-4 d-flex align-items-center gap-2">
                <i class="fa-regular fa-envelope"></i>
                {{ formularioUsuario.email || 'usuario@correo.com' }}
              </div>

              <!-- Status Toggle (Pill Style) -->
              <div class="card border-0 shadow-sm w-100 bg-white overflow-hidden mt-2">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                  <div class="text-start">
                    <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.65rem;">Acceso al
                      Sistema</small>
                    <span class="badge rounded-pill" [class.bg-success]="formularioUsuario.activo"
                      [class.bg-danger]="!formularioUsuario.activo">
                      {{ formularioUsuario.activo ? 'Habilitado' : 'Bloqueado' }}
                    </span>
                  </div>
                  <div class="form-check form-switch m-0 pb-1">
                    <input class="form-check-input fs-4 cursor-pointer" type="checkbox" role="switch" id="checkActivo"
                      [(ngModel)]="formularioUsuario.activo" name="activo">
                  </div>
                </div>
              </div>

            </div>

            <!-- Right Content: Form Fields -->
            <div class="col-lg-8 p-2 bg-white">

              <!-- Personal Info Section -->
              <div class="mb-4">
                <h6 class="fw-bold text-primary mb-3 ps-1 border-start border-4 border-primary ps-2">Información
                  Personal</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" [(ngModel)]="formularioUsuario.nombre" name="nombre" required
                        class="form-control bg-light-input" id="floatingNombre" placeholder="Nombre">
                      <label for="floatingNombre"><i class="fa-regular fa-user me-1 text-muted"></i> Nombre *</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" [(ngModel)]="formularioUsuario.apellido" name="apellido" required
                        class="form-control bg-light-input" id="floatingApellido" placeholder="Apellido">
                      <label for="floatingApellido">Apellido *</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="tel" [(ngModel)]="formularioUsuario.telefono" name="telefono"
                        class="form-control bg-light-input" id="floatingTel" placeholder="Telefono">
                      <label for="floatingTel"><i class="fa-solid fa-phone me-1 text-muted"></i> Teléfono</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="email" [(ngModel)]="formularioUsuario.email" name="email" required
                        class="form-control bg-light-input" id="floatingEmail" placeholder="correo">
                      <label for="floatingEmail"><i class="fa-regular fa-envelope me-1 text-muted"></i> Correo
                        Electrónico *</label>
                    </div>
                  </div>
                </div>
              </div>

              <hr class="border-light my-4">

              <!-- Account Info Section -->
              <div class="mb-2">
                <h6 class="fw-bold text-primary mb-3 ps-1 border-start border-4 border-primary ps-2">Cuenta y Seguridad
                </h6>
                <div class="row g-3">

                  <div class="col-md-6">
                    <div class="form-floating input-group has-validation">
                      <input type="text" [(ngModel)]="formularioUsuario.username" name="username" required
                        class="form-control bg-light-input" id="floatingUser" placeholder="usuario">
                      <label for="floatingUser"><i class="fa-solid fa-at me-1 text-muted"></i> Usuario *</label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <select [(ngModel)]="formularioUsuario.rol_id" name="rol_id" required
                        class="form-select bg-light-input" id="floatingRol">
                        <option value="" disabled selected>Seleccionar...</option>
                        <option *ngFor="let rol of roles" [value]="rol.id">{{ rol.nombre }}</option>
                      </select>
                      <label for="floatingRol"><i class="fa-solid fa-user-shield me-1 text-muted"></i> Rol Asignado
                        *</label>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="form-floating">
                      <input type="password" [(ngModel)]="formularioUsuario.password" name="password"
                        [required]="modoModal === 'crear'" class="form-control bg-light-input" id="floatingPass"
                        placeholder="Contraseña">
                      <label for="floatingPass"><i class="fa-solid fa-lock me-1 text-muted"></i>
                        Contraseña {{ modoModal === 'crear' ? '*' : '(Opcional para actualizar)' }}
                      </label>
                    </div>
                  </div>

                </div>
              </div>

              <!-- Footer Buttons -->
              <div class="d-flex justify-content-end gap-3 mt-4 pt-4 border-top">
                <button type="button" class="btn btn-outline-secondary px-4 fw-medium" (click)="cerrarModal()">
                  Cancelar
                </button>
                <button type="submit" [disabled]="isSaving || !usuarioForm.form.valid"
                  class="btn btn-primary px-5 fw-bold shadow-sm d-flex align-items-center gap-2">
                  @if (isSaving) {
                  <span class="spinner-border spinner-border-sm"></span> Guardando...
                  } @else {
                  <i class="fa-solid fa-floppy-disk"></i> {{ modoModal === 'crear' ? 'Crear Usuario' : 'Guardar Cambios'
                  }}
                  }
                </button>
              </div>

            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>