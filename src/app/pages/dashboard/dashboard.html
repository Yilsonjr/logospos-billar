<div class="container-fluid p-2 bg-light d-flex flex-column h-100" style="height: 100%;">

  <!-- Header (Fijo altura aprox) -->
  <header class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 mb-2">
    <!-- Búsqueda -->
    <div class="position-relative w-100" style="max-width: 400px;">
      <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">
        <i class="fa-solid fa-search small"></i>
      </span>
      <input type="text" class="form-control ps-5 border-0 shadow-sm" placeholder="Buscar...">
    </div>

    <!-- Acciones -->
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-white shadow-sm border text-secondary btn-sm" title="Configuración"
        routerLink="/admin/sistema">
        <i class="fa-solid fa-cog"></i>
      </button>
      <button class="btn btn-primary shadow-sm d-flex align-items-center gap-2 fw-bold px-3 btn-sm"
        routerLink="/ventas/nueva">
        <i class="fa-solid fa-plus"></i> Nueva Venta
      </button>
    </div>
  </header>

  <!-- Tarjetas de Estadísticas (Fijo altura aprox) -->
  <section class="row g-2 mb-2">
    @for (stat of stats; track stat.title) {
    <div class="col-md-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100 stat-card">
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="text-uppercase text-muted fw-bold small tracking-widest"
              style="font-size: 0.7rem;">{{stat.title}}</span>
            <div [class]="'p-2 rounded-circle d-flex align-items-center justify-content-center ' + stat.iconBg"
              style="width: 36px; height: 36px;">
              <i [class]="'fa-solid ' + stat.icon + ' fs-6'"></i>
            </div>
          </div>

          <h3 class="fw-semibold text-dark mb-1">{{stat.value}}</h3>

          <div class="d-flex align-items-center gap-2 small">
            @if (stat.isUrgent) {
            <span class="text-danger fw-bold">{{stat.change}}</span>
            } @else {
            <span [class]="stat.isPositive ? 'text-success' : 'text-danger'" class="fw-bold d-flex align-items-center">
              <i [class]="stat.isPositive ? 'fa-solid fa-arrow-up me-1' : 'fa-solid fa-arrow-down me-1'"></i>
              {{stat.change}}
            </span>
            }
          </div>
        </div>
      </div>
    </div>
    }
  </section>

  <!-- Sección Principal (Flexible para ocupar el resto de altura) -->
  <section class="row g-2 flex-grow-1" style="min-height: 0;">
    <!-- min-height:0 permite scroll interno en flex items -->

    <!-- Columna Izquierda: Tendencias de Ventas (8 cols) -->
    <div class="col-lg-8 h-100 d-flex flex-column">
      <div class="card border-0 shadow-sm flex-grow-1" style="min-height: 300px;">
        <div
          class="card-header bg-white border-0 pt-3 px-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <h5 class="fw-bold text-dark mb-0">Tendencias de ventas</h5>
            <small class="text-muted">Rendimiento en los últimos 7 días</small>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn" [class.btn-primary]="selectedPeriod === 'weekly'"
              [class.btn-outline-light]="selectedPeriod !== 'weekly'" [class.text-dark]="selectedPeriod !== 'weekly'"
              (click)="setPeriod('weekly')">Semanal</button>
            <button class="btn btn-primary-outline text-dark"
              style="opacity: 0.5; pointer-events: none;">Mensual</button>
            <button class="btn btn-primary-outline text-dark" style="opacity: 0.5; pointer-events: none;">Anual</button>
          </div>
        </div>

        <div class="card-body px-3 pb-3 d-flex flex-column overflow-hidden">
          @if (isLoading) {
          <div class="d-flex justify-content-center align-items-center flex-grow-1">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
          } @else if (chartData.length === 0) {
          <div class="text-center flex-grow-1 d-flex flex-column justify-content-center text-muted">
            <i class="fa-solid fa-chart-line fa-3x mb-3 opacity-25"></i>
            <p>No hay datos de ventas</p>
          </div>
          } @else {
          <!-- Gráfico simple con barras CSS (Flex) -->
          <div class="d-flex align-items-end justify-content-around flex-grow-1 mt-2 border-bottom pb-2 h-100">
            @for (data of chartData; track data.label) {
            <div class="d-flex flex-column align-items-center gap-1 flex-grow-1 group"
              style="max-width: 60px; height: 100%;">
              <div
                class="w-100 rounded-top position-relative d-flex justify-content-center bar-container h-100 d-flex align-items-end">
                <div class="w-100 rounded-top"
                  style="background: linear-gradient(to top, #3b82f6, #93c5fd); transition: height 0.5s ease; min-height: 4px;"
                  [style.height.%]="data.percentage" [title]="formatearMoneda(data.value)">
                </div>
                <span
                  class="position-absolute top-0 start-50 translate-middle-x badge bg-dark opacity-0 bar-tooltip mb-2">
                  {{formatearMoneda(data.value)}}
                </span>
              </div>
              <small class="text-muted fw-bold" style="font-size: 0.75rem;">{{data.label}}</small>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Columna Derecha: Panel de Pestañas (4 cols) -->
    <div class="col-lg-4 h-100 d-flex flex-column">
      <div class="card border-0 shadow-sm flex-grow-1" style="min-height: 0;">

        <!-- Header de Pestañas -->
        <div class="card-header bg-white border-0 pt-2 px-2 pb-0 flex-shrink-0">
          <ul class="nav nav-tabs card-header-tabs border-bottom-0">
            <li class="nav-item">
              <a class="nav-link border-0 fw-bold small text-uppercase py-2" [class.active]="activeTab === 'products'"
                [class.text-primary]="activeTab === 'products'" [class.text-muted]="activeTab !== 'products'"
                style="cursor: pointer;" (click)="activeTab = 'products'">
                <i class="fa-solid fa-star me-1"></i> Top Productos
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link border-0 fw-bold small text-uppercase py-2"
                [class.active]="activeTab === 'transactions'" [class.text-primary]="activeTab === 'transactions'"
                [class.text-muted]="activeTab !== 'transactions'" style="cursor: pointer;"
                (click)="activeTab = 'transactions'">
                <i class="fa-solid fa-clock-rotate-left me-1"></i> Recientes
              </a>
            </li>
          </ul>
        </div>

        <!-- Contenido Scrollable Independiente -->
        <div class="card-body px-3 py-2 overflow-auto flex-grow-1">

          <!-- CONTENIDO TAB 1: PRODUCTOS -->
          @if (activeTab === 'products') {
          @if (isLoading) {
          <div class="d-flex justify-content-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
          </div>
          } @else if (topProducts.length === 0) {
          <div class="text-center py-4 text-muted small">No hay datos</div>
          } @else {
          <div class="list-group list-group-flush">
            @for (product of topProducts; track product.name) {
            <div class="list-group-item border-0 px-0 py-2 d-flex align-items-center gap-2">
              <div class="rounded-3 d-flex align-items-center justify-content-center text-white fw-bold shadow-sm"
                style="width: 36px; height: 36px; background: linear-gradient(135deg, #3b82f6, #2563eb); font-size: 0.8rem;">
                {{product.initials}}
              </div>
              <div class="flex-grow-1 overflow-hidden" style="line-height: 1.2;">
                <h6 class="mb-0 text-truncate fw-semibold small">{{product.name}}</h6>
                <small class="text-muted" style="font-size: 0.7rem;">{{product.category}}</small>
              </div>
              <div class="text-end" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">{{product.price}}</div>
                <small class="text-success fw-bold" style="font-size: 0.7rem;">{{product.sales}}</small>
              </div>
            </div>
            }
          </div>
          <button class="btn btn-outline-primary btn-sm w-100 mt-2" (click)="viewAllItems()">Ver todo</button>
          }
          }

          <!-- CONTENIDO TAB 2: TRANSACCIONES -->
          @if (activeTab === 'transactions') {
          @if (isLoading) {
          <div class="d-flex justify-content-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
          </div>
          } @else if (transactions.length === 0) {
          <div class="text-center py-4 text-muted small">No hay transacciones</div>
          } @else {
          <div class="list-group list-group-flush">
            @for (t of transactions; track t.id) {
            <div class="list-group-item border-0 px-0 py-2 d-flex align-items-center justify-content-between">
              <div class="d-flex flex-column" style="line-height: 1.2;">
                <span class="fw-bold text-dark small">#{{t.id}}</span>
                <small class="text-muted" style="font-size: 0.75rem;">{{t.customer}}</small>
                <small class="text-muted" style="font-size: 0.7rem;">{{t.date}}</small>
              </div>
              <div class="text-end d-flex flex-column align-items-end" style="line-height: 1.2;">
                <span class="fw-bold text-primary small">{{t.total}}</span>
                <span class="badge rounded-pill" style="font-size: 0.65rem;"
                  [class.bg-success-subtle]="t.status === 'completed'" [class.text-success]="t.status === 'completed'"
                  [class.bg-warning-subtle]="t.status !== 'completed'" [class.text-warning]="t.status !== 'completed'">
                  {{t.status === 'completed' ? 'PAGADO' : 'PENDIENTE'}}
                </span>
              </div>
            </div>
            }
          </div>
          <button class="btn btn-outline-secondary btn-sm w-100 mt-2" (click)="exportReport()">
            <i class="fa-solid fa-download me-1"></i> Exportar
          </button>
          }
          }

        </div>
      </div>
    </div>
  </section>

  @if (modoFiscalActivo) {
  <section class="mt-2 mb-2">
    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fff 0%, #fffbeb 100%);">
      <div class="card-body p-3 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <div class="rounded-circle p-2 d-flex align-items-center justify-content-center"
            style="background:#fef3c7; color:#d97706; width:45px; height:45px;">
            <i class="fa-solid fa-file-invoice-dollar fs-4"></i>
          </div>
          <div>
            <h6 class="fw-bold mb-0" style="color:#92400e;">Gestión Fiscal (DGII)</h6>
            <small class="text-muted">Genera y exporta tus formatos 606 y 607 mensualmente.</small>
          </div>
        </div>
        <div class="d-flex gap-2 w-100 w-md-auto">
          <button (click)="generarReporte606()" class="btn btn-sm px-3 flex-fill"
            style="background:#fde68a; color:#92400e; border:1px solid #fcd34d; font-weight:600;">
            <i class="fa-solid fa-download me-1"></i> Reporte 606 (Compras)
          </button>
          <button (click)="generarReporte607()" class="btn btn-sm px-3 flex-fill"
            style="background:#fde68a; color:#92400e; border:1px solid #fcd34d; font-weight:600;">
            <i class="fa-solid fa-download me-1"></i> Reporte 607 (Ventas)
          </button>
        </div>
      </div>
    </div>
  </section>
  }
</div>