<div class="reports-container p-4 p-lg-6 bg-light min-vh-100">
    <div class="max-w-xxl mx-auto">

        <!-- Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-5">
            <div>
                <h1 class="h2 fw-bolder text-dark mb-1">Reporte de Ventas</h1>
                <p class="text-muted mb-0">Análisis detallado de transacciones y rendimiento comercial</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-export animate__animated animate__fadeIn" (click)="exportarReporte()"
                    [disabled]="isLoading">
                    <i class="fa-solid fa-file-csv me-2"></i>Exportar Excel
                </button>
            </div>
        </div>

        <!-- Filtros Rápidos -->
        <div class="premium-card mb-5 border-0">
            <div class="row g-4 align-items-end">
                <div class="col-md-3">
                    <label class="card-label">Desde</label>
                    <input type="date" class="form-control border-light shadow-none rounded-3" [(ngModel)]="fechaInicio"
                        (change)="aplicarFiltrosYCalcular()">
                </div>
                <div class="col-md-3">
                    <label class="card-label">Hasta</label>
                    <input type="date" class="form-control border-light shadow-none rounded-3" [(ngModel)]="fechaFin"
                        (change)="aplicarFiltrosYCalcular()">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-light w-100 py-2 rounded-3 fw-bold text-primary" (click)="cargarReporte()"
                        [disabled]="isLoading">
                        <i class="fa-solid fa-arrows-rotate me-2" [class.fa-spin]="isLoading"></i>Recargar Datos
                    </button>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center gap-2 p-2 bg-light rounded-3">
                        <i class="fa-solid fa-circle-info text-info ms-2"></i>
                        <span class="small text-muted">Ventas fiscalmente
                            @if(modoFiscalActivo){activas}@else{desactivas}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen Premium -->
        <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
            <div class="col-6 col-lg">
                <div class="premium-card">
                    <div class="stats-icon bg-soft-primary text-primary" style="background: rgba(54, 153, 255, 0.1);">
                        <i class="fa-solid fa-sack-dollar"></i>
                    </div>
                    <span class="card-label">Ventas Totales</span>
                    <h3 class="card-value">{{ formatearMoneda(totalVentas) }}</h3>
                    <div class="mt-2 small text-muted">
                        <i class="fa-solid fa-receipt me-1"></i> {{ totalTransacciones }} transacciones
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg">
                <div class="premium-card">
                    <div class="stats-icon bg-soft-success text-success" style="background: rgba(16, 185, 129, 0.1);">
                        <i class="fa-solid fa-money-bill-1-wave"></i>
                    </div>
                    <span class="card-label">Cobro Efectivo</span>
                    <h3 class="card-value">{{ formatearMoneda(totalEfectivo) }}</h3>
                    <div class="mt-2 method-bar">
                        <div class="method-progress bg-success" [style.width.%]="(totalEfectivo/totalVentas)*100"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg">
                <div class="premium-card">
                    <div class="stats-icon bg-soft-info text-info" style="background: rgba(54, 153, 255, 0.1);">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <span class="card-label">Tarjeta/Transferencia</span>
                    <h3 class="card-value">{{ formatearMoneda(totalTarjeta) }}</h3>
                    <div class="mt-2 method-bar">
                        <div class="method-progress bg-info" [style.width.%]="(totalTarjeta/totalVentas)*100"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg">
                <div class="premium-card">
                    <div class="stats-icon bg-soft-warning text-warning" style="background: rgba(246, 173, 85, 0.1);">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <span class="card-label">Ticket Promedio</span>
                    <h3 class="card-value">{{ formatearMoneda(ticketPromedio) }}</h3>
                    <div class="mt-2 small text-muted">Ingreso promedio por cliente</div>
                </div>
            </div>
            <div class="col-12 col-lg">
                <div class="premium-card" style="border-left: 4px solid #8b5cf6;">
                    <div class="stats-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="fa-solid fa-hand-holding-dollar"></i>
                    </div>
                    <span class="card-label">Ganancia Bruta</span>
                    <h3 class="card-value" style="color: #8b5cf6;">{{ formatearMoneda(totalGanancia) }}</h3>
                    <div class="mt-2 small">
                        <span class="badge rounded-pill px-2 py-1"
                            [style.background]="margenPromedio >= 30 ? 'rgba(16,185,129,0.15)' : 'rgba(246,173,85,0.15)'"
                            [style.color]="margenPromedio >= 30 ? '#10b981' : '#f59e0b'">
                            <i class="fa-solid fa-arrow-trend-up me-1"></i>{{ margenPromedio | number:'1.1-1' }}% margen
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <!-- Insights: Top Productos -->
            <div class="col-lg-7">
                <div class="premium-card border-0">
                    <h5 class="fw-bold mb-4 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-star text-warning"></i>
                        Productos Estrella (Top 5)
                    </h5>

                    <div class="top-product-list">
                        @for (prod of topProductos; track prod.nombre; let i = $index) {
                        <div class="top-product-item animate__animated animate__fadeInLeft"
                            [style.animation-delay]="i * 0.1 + 's'">
                            <div class="d-flex align-items-center gap-3">
                                <div class="product-rank">{{ i + 1 }}</div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark">{{ prod.nombre }}</div>
                                    <div class="small text-muted">{{ prod.cantidad }} unidades vendidas</div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-primary">{{ formatearMoneda(prod.total) }}</div>
                                    <div class="small" style="color: #8b5cf6;">
                                        <i class="fa-solid fa-arrow-trend-up me-1"></i>{{ formatearMoneda(prod.ganancia)
                                        }}
                                    </div>
                                    <div class="method-bar" style="width: 100px; height: 4px;">
                                        <div class="method-progress bg-primary"
                                            [style.width.%]="(prod.cantidad / topProductos[0].cantidad) * 100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        } @empty {
                        <div class="text-center py-4 opacity-50">
                            <i class="fa-solid fa-box-open fa-2x mb-2"></i>
                            <p>Cargando análisis de productos...</p>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Insights: Métodos de Pago -->
            <div class="col-lg-5">
                <div class="premium-card border-0">
                    <h5 class="fw-bold mb-4 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-primary"></i>
                        Mezcla de Cobro
                    </h5>

                    <div class="mt-4">
                        @for (metodo of distribucionMetodos; track metodo.nombre) {
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small fw-bold text-muted">{{ metodo.nombre }}</span>
                                <span class="small fw-bold" [style.color]="metodo.color">{{ metodo.valor |
                                    number:'1.0-1' }}%</span>
                            </div>
                            <div class="method-bar" style="height: 10px;">
                                <div class="method-progress" [style.background-color]="metodo.color"
                                    [style.width.%]="metodo.valor"></div>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Detallada -->
        <div class="premium-card p-0 border-0 overflow-hidden shadow-sm">
            <div class="p-4 border-bottom border-light d-flex justify-content-between align-items-center bg-white">
                <h5 class="fw-bold mb-0">Detalle de Transacciones</h5>
                <span class="badge bg-light text-dark rounded-pill">{{ ventasFiltradas.length }} Registros</span>
            </div>

            <div class="table-responsive p-3">
                <table class="table premium-table mb-0">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Nº Factura</th>
                            @if(modoFiscalActivo){ <th>NCF</th> }
                            <th>Cliente</th>
                            <th>Método</th>
                            <th class="text-end">Total</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (venta of ventasFiltradas; track venta.id) {
                        <tr class="animate__animated animate__fadeIn">
                            <td class="fw-medium text-dark">{{ formatearFecha(venta.created_at || '') }}</td>
                            <td><code class="text-muted">#{{ venta.numero_venta }}</code></td>
                            @if(modoFiscalActivo){
                            <td>
                                @if(venta.ncf){
                                <span class="badge bg-soft-warning text-warning border border-warning"
                                    style="background: rgba(246, 173, 85, 0.1);">{{ venta.ncf }}</span>
                                } @else { <span class="text-muted opacity-50">—</span> }
                            </td>
                            }
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center text-muted"
                                        style="width: 28px; height: 28px; font-size: 0.7rem;">
                                        <i class="fa-solid fa-user"></i>
                                    </div>
                                    @if(venta.cliente_id){ <span class="fw-bold">Cliente #{{ venta.cliente_id }}</span>
                                    }
                                    @else { <span class="text-muted fst-italic">C. General</span> }
                                </div>
                            </td>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 text-uppercase"
                                    [style.background-color]="venta.metodo_pago === 'efectivo' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(54, 153, 255, 0.1)'"
                                    [style.color]="venta.metodo_pago === 'efectivo' ? '#10b981' : '#3699ff'">
                                    {{ venta.metodo_pago }}
                                </span>
                            </td>
                            <td class="text-end fw-bolder text-dark">{{ formatearMoneda(venta.total) }}</td>
                            <td class="text-center">
                                <span class="badge rounded-pill" [class.bg-success]="venta.estado === 'completada'"
                                    [class.bg-danger]="venta.estado === 'cancelada'">
                                    {{ venta.estado === 'completada' ? '✓ Éxito' : '✕ Anulada' }}
                                </span>
                            </td>
                        </tr>
                        } @empty {
                        <tr>
                            <td [attr.colspan]="modoFiscalActivo ? 7 : 6" class="text-center py-5">
                                <div class="opacity-25 mb-3">
                                    <i class="fa-solid fa-folder-open fa-4x"></i>
                                </div>
                                <h5 class="text-muted">No hay transacciones en este rango</h5>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>